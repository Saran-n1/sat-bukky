<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SAT BUKKY ‚Äî F1 Racing Quiz v12 (Fixed Multiplayer)</title>

<!-- Firebase SDK (from V4 - WORKING) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FIREBASE CONFIG (from V4)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const FIREBASE_CONFIG = {
  apiKey:      "AIzaSyBXdXjtMbQum_l1GBcl8dVcphWcZ2SgsBw",
  databaseURL: "https://sat-bukky-default-rtdb.asia-southeast1.firebasedatabase.app/",
  projectId:   "sat-bukky",
};

let db;
try {
  firebase.initializeApp(FIREBASE_CONFIG);
  db = firebase.database();
} catch(e) { console.error('Firebase init failed:', e); }
</script>

<style>
/* ===== V12 STYLES (Enhanced UI, F1 Theme) ===== */
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;800;900&family=Rajdhani:wght@400;500;600;700&family=Share+Tech+Mono&display=swap');

:root{
  --void:#01020a;--deep:#04091a;--panel:rgba(3,9,26,0.97);
  --border:rgba(0,210,255,0.16);--cyan:#00d4ff;--green:#00ffaa;
  --yellow:#ffdf00;--pink:#ff2d7a;--orange:#ff6a00;--white:#dff0ff;
  --dim:rgba(120,170,230,0.45);--carbon:rgba(8,14,32,0.95);
  --glow-cyan:0 0 16px rgba(0,212,255,0.7),0 0 48px rgba(0,212,255,0.25),0 0 100px rgba(0,212,255,0.08);
  --glow-green:0 0 16px rgba(0,255,170,0.7),0 0 48px rgba(0,255,170,0.25);
  --glow-yellow:0 0 16px rgba(255,223,0,0.7),0 0 48px rgba(255,223,0,0.25);
  --glow-pink:0 0 16px rgba(255,45,122,0.7),0 0 48px rgba(255,45,122,0.25);
  --stripe:linear-gradient(135deg,rgba(255,255,255,.04) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.04) 50%,rgba(255,255,255,.04) 75%,transparent 75%);
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
html,body{width:100%;height:100%;overflow:hidden;background:var(--void);font-family:'Rajdhani',sans-serif;color:var(--white);user-select:none;}
canvas#bg{position:fixed;inset:0;z-index:0;pointer-events:none;}
body::after{content:'';position:fixed;inset:0;z-index:1;pointer-events:none;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.06) 2px,rgba(0,0,0,.06) 4px);animation:scanPan 8s linear infinite;}
@keyframes scanPan{0%{background-position:0 0;}100%{background-position:0 100px;}}
.screen{position:fixed;inset:0;z-index:10;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:1.5rem;transition:opacity .4s cubic-bezier(.4,0,.2,1),transform .4s cubic-bezier(.4,0,.2,1);}
.screen.out{opacity:0;transform:scale(.96) translateY(8px);pointer-events:none;}
.screen.gone{display:none!important;}
.logo-wrap{text-align:center;margin-bottom:2rem;}
.logo-main{font-family:'Orbitron',monospace;font-weight:900;font-size:clamp(2.4rem,7vw,4.8rem);letter-spacing:.08em;line-height:1;background:linear-gradient(135deg,#00d4ff 0%,#00ffaa 40%,#ffdf00 75%,#ff6a00 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;filter:drop-shadow(0 0 30px rgba(0,212,255,.5)) drop-shadow(0 0 60px rgba(0,212,255,.2));animation:logoBeat 2.5s ease-in-out infinite;}
.logo-sub{font-family:'Share Tech Mono',monospace;font-size:.58rem;letter-spacing:.5em;color:rgba(0,212,255,.4);margin-top:.4rem;text-transform:uppercase;}
@keyframes logoBeat{0%,100%{filter:drop-shadow(0 0 28px rgba(0,212,255,.5)) drop-shadow(0 0 60px rgba(0,212,255,.15));}50%{filter:drop-shadow(0 0 40px rgba(0,255,170,.6)) drop-shadow(0 0 80px rgba(0,255,170,.2));}}
.btn{font-family:'Orbitron',monospace;font-size:.7rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;padding:.75rem 2.2rem;border:1px solid;background:transparent;cursor:pointer;clip-path:polygon(12px 0%,100% 0%,calc(100% - 12px) 100%,0% 100%);transition:all .2s cubic-bezier(.4,0,.2,1);position:relative;overflow:hidden;}
.btn::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,.06) 0%,transparent 60%);pointer-events:none;}
.btn::after{content:'';position:absolute;inset:0;background:currentColor;opacity:0;transition:opacity .2s;}
.btn:hover::after{opacity:.1;}
.btn:active{transform:scale(.96);}
.btn-cyan{border-color:var(--cyan);color:var(--cyan);}
.btn-green{border-color:var(--green);color:var(--green);}
.btn-pink{border-color:var(--pink);color:var(--pink);}
.btn-yellow{border-color:var(--yellow);color:var(--yellow);}
.btn-dim{border-color:rgba(100,140,200,.35);color:rgba(100,140,200,.55);}
.btn-cyan:hover{box-shadow:var(--glow-cyan);border-color:var(--cyan);}
.btn-green:hover{box-shadow:var(--glow-green);border-color:var(--green);}
.btn-yellow:hover{box-shadow:var(--glow-yellow);border-color:var(--yellow);}
.btn-full{width:100%;text-align:center;}
.btn-row{display:flex;gap:.75rem;flex-wrap:wrap;justify-content:center;}
.card{background:var(--carbon);border:1px solid var(--border);border-radius:4px;padding:1.8rem;width:100%;max-width:440px;position:relative;backdrop-filter:blur(20px);}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent 0%,var(--cyan) 30%,var(--green) 70%,transparent 100%);}
.card::after{content:'';position:absolute;inset:0;border-radius:4px;background:var(--stripe);background-size:8px 8px;pointer-events:none;opacity:.4;}
.card-title{font-family:'Orbitron',monospace;font-size:.75rem;letter-spacing:.28em;color:var(--cyan);text-align:center;margin-bottom:1.2rem;text-shadow:var(--glow-cyan);}
.field{margin-bottom:.9rem;}
.field label{display:block;font-size:.6rem;letter-spacing:.18em;color:var(--dim);margin-bottom:.3rem;font-family:'Orbitron',monospace;}
.field input,.field select{width:100%;background:rgba(0,40,100,.3);border:1px solid rgba(0,160,255,.2);color:var(--white);font-family:'Orbitron',monospace;font-size:.78rem;padding:.55rem .75rem;border-radius:2px;outline:none;transition:border-color .2s,box-shadow .2s;}
.field input:focus,.field select:focus{border-color:var(--cyan);box-shadow:0 0 0 3px rgba(0,212,255,.08),inset 0 0 20px rgba(0,212,255,.05);}
.field input::placeholder{color:rgba(80,130,190,.4);}
.err{color:var(--pink);font-size:.66rem;text-align:center;min-height:1em;margin:.25rem 0;font-family:'Share Tech Mono',monospace;}
.track-row{display:flex;gap:.4rem;margin:.4rem 0 .6rem;flex-wrap:wrap;}
.trk-btn{flex:1;min-width:70px;padding:.5rem .2rem;background:rgba(0,40,100,.25);border:1px solid rgba(0,150,255,.15);color:rgba(120,170,220,.55);font-family:'Orbitron',monospace;font-size:.48rem;letter-spacing:.06em;cursor:pointer;text-align:center;border-radius:3px;transition:all .2s cubic-bezier(.4,0,.2,1);}
.trk-btn.sel{border-color:var(--cyan);color:var(--cyan);background:rgba(0,212,255,.08);box-shadow:0 0 16px rgba(0,212,255,.2),inset 0 0 20px rgba(0,212,255,.04);}
.trk-btn:hover{border-color:rgba(0,212,255,.4);color:rgba(0,212,255,.8);}
.trk-emoji{font-size:1rem;display:block;margin-bottom:.2rem;}
.car-grid{display:grid;grid-template-columns:1fr 1fr;gap:.7rem;margin:.5rem 0;}
.car-card{background:rgba(0,15,45,.5);border:1px solid rgba(0,100,200,.2);border-radius:6px;padding:.75rem;cursor:pointer;transition:all .22s cubic-bezier(.4,0,.2,1);text-align:center;position:relative;overflow:hidden;}
.car-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.12),transparent);}
.car-card:hover{border-color:rgba(0,212,255,.45);background:rgba(0,25,70,.5);transform:translateY(-1px);}
.car-card.sel{border-color:var(--yellow);background:rgba(255,215,0,.06);box-shadow:0 0 24px rgba(255,215,0,.18),inset 0 0 30px rgba(255,215,0,.04);}
.car-canvas{width:100%;height:70px;display:block;}
.car-name{font-family:'Orbitron',monospace;font-size:.5rem;letter-spacing:.1em;margin-top:.3rem;font-weight:700;}
.car-team{font-size:.48rem;color:var(--dim);margin-top:.1rem;font-family:'Rajdhani',sans-serif;letter-spacing:.05em;}
.code-box{font-family:'Orbitron',monospace;font-size:2.2rem;font-weight:900;letter-spacing:.5em;color:var(--yellow);text-align:center;padding:.75rem;margin:.6rem 0;background:rgba(255,215,0,.04);border:1px solid rgba(255,215,0,.2);border-radius:4px;text-shadow:var(--glow-yellow);}
.slot-list{display:flex;flex-direction:column;gap:.35rem;margin:.6rem 0;}
.slot{display:flex;align-items:center;gap:.6rem;padding:.5rem .75rem;background:rgba(0,80,180,.06);border:1px solid rgba(0,100,200,.15);border-radius:3px;font-size:.82rem;}
.slot.empty{color:rgba(70,100,150,.5);font-style:italic;border-style:dashed;}
.slot-dot{width:9px;height:9px;border-radius:50%;flex-shrink:0;box-shadow:0 0 10px currentColor;}
.slot-host-badge{margin-left:auto;font-family:'Orbitron',monospace;font-size:.48rem;color:var(--yellow);letter-spacing:.1em;text-shadow:var(--glow-yellow);}
#gameCanvas{position:fixed;inset:0;z-index:5;display:none;}
#hud{position:fixed;inset:0;z-index:20;pointer-events:none;display:none;}
.hud-top{display:flex;justify-content:space-between;align-items:flex-start;padding:.7rem .9rem;}
.hud-card{background:rgba(1,5,18,.92);border:1px solid rgba(0,210,255,.18);border-radius:4px;padding:.45rem .65rem;min-width:130px;backdrop-filter:blur(16px);position:relative;overflow:hidden;}
.hud-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--cyan),transparent);}
.hud-name{font-family:'Orbitron',monospace;font-size:.58rem;letter-spacing:.08em;margin-bottom:.18rem;font-weight:700;}
.hud-stat{font-size:.66rem;color:var(--dim);font-family:'Rajdhani',sans-serif;font-weight:600;letter-spacing:.04em;}
.hud-stat b{color:var(--white);font-weight:700;}
.hud-center{display:flex;flex-direction:column;align-items:center;gap:.15rem;}
.hud-cp{font-family:'Orbitron',monospace;font-size:.66rem;color:var(--cyan);letter-spacing:.12em;text-shadow:var(--glow-cyan);}
.hud-time{font-family:'Share Tech Mono',monospace;font-size:.68rem;color:rgba(0,212,255,.7);letter-spacing:.05em;}
.hud-others{display:flex;flex-direction:column;gap:.28rem;}
.boost-hud{position:absolute;bottom:1.2rem;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:.6rem;}
.boost-label{font-family:'Orbitron',monospace;font-size:.5rem;color:var(--orange);letter-spacing:.12em;text-shadow:0 0 10px var(--orange);}
.boost-track{width:140px;height:7px;background:rgba(255,100,0,.1);border:1px solid rgba(255,106,0,.4);border-radius:4px;overflow:hidden;}
.boost-fill{height:100%;background:linear-gradient(90deg,#ff3a00,#ff9a00,#ffdf00);box-shadow:0 0 12px #ff6a00,0 0 24px rgba(255,106,0,.4);transition:width .08s linear;}
.ctrl-hint{position:absolute;bottom:1rem;right:1rem;font-family:'Share Tech Mono',monospace;font-size:.5rem;color:rgba(70,100,150,.45);line-height:1.8;}
#ping{position:absolute;top:.8rem;left:50%;transform:translateX(-50%);font-family:'Orbitron',monospace;font-size:.5rem;padding:.25rem .8rem;border-radius:12px;background:rgba(0,0,0,.6);border:1px solid;transition:all .3s;z-index:30;pointer-events:none;}
#ping.ok{color:var(--green);border-color:rgba(0,255,170,.3);}
#ping.lag{color:var(--yellow);border-color:rgba(255,223,0,.3);}
#ping.bad{color:var(--pink);border-color:rgba(255,45,122,.3);}
#qOverlay{position:fixed;inset:0;z-index:50;background:rgba(0,2,12,.88);display:none;align-items:center;justify-content:center;backdrop-filter:blur(12px);}
.q-card{background:rgba(1,6,22,.99);border:1px solid var(--cyan);border-radius:8px;padding:1.8rem;width:90%;max-width:500px;box-shadow:var(--glow-cyan),0 40px 100px rgba(0,0,0,.8);position:relative;overflow:hidden;}
.q-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--cyan),var(--green),var(--cyan),transparent);animation:qSweep 2s linear infinite;}
.q-card::after{content:'';position:absolute;inset:0;background:var(--stripe);background-size:8px 8px;opacity:.25;pointer-events:none;}
@keyframes qSweep{0%{background-position:-200% 0;}100%{background-position:200% 0;}}
.q-cp-label{font-family:'Orbitron',monospace;font-size:.52rem;color:var(--cyan);letter-spacing:.32em;margin-bottom:.5rem;text-shadow:var(--glow-cyan);}
.q-timer{position:absolute;top:1rem;right:1rem;font-family:'Orbitron',monospace;font-size:1.8rem;font-weight:900;color:var(--yellow);width:40px;text-align:center;text-shadow:var(--glow-yellow);}
.q-timer.red{color:var(--pink);animation:timerFlash .3s infinite;text-shadow:var(--glow-pink);}
@keyframes timerFlash{0%,100%{opacity:1}50%{opacity:.15}}
.q-text{font-size:1rem;line-height:1.55;margin:.8rem 0 1.2rem;color:rgba(215,235,255,.95);font-weight:600;font-family:'Rajdhani',sans-serif;letter-spacing:.02em;}
.q-opts{display:flex;gap:.7rem;}
.q-opt{flex:1;padding:.9rem .7rem;background:rgba(0,35,100,.25);border:1px solid rgba(0,120,255,.22);color:rgba(160,200,255,.85);font-family:'Orbitron',monospace;font-size:.62rem;cursor:pointer;border-radius:5px;transition:all .15s cubic-bezier(.4,0,.2,1);text-align:left;position:relative;overflow:hidden;}
.q-opt:hover{border-color:var(--cyan);background:rgba(0,212,255,.08);color:#fff;transform:translateY(-1px);}
.q-opt.correct{border-color:var(--green);background:rgba(0,255,170,.1);color:var(--green);box-shadow:var(--glow-green);}
.q-opt.wrong{border-color:var(--pink);background:rgba(255,45,122,.1);color:var(--pink);box-shadow:var(--glow-pink);}
.q-opt .ol{font-size:1rem;font-weight:900;margin-bottom:.2rem;}
.q-opt .ot{font-size:.62rem;line-height:1.3;opacity:.9;}
.q-feedback{text-align:center;margin-top:.8rem;font-family:'Orbitron',monospace;font-size:.68rem;min-height:1em;letter-spacing:.08em;}
.q-feedback.ok{color:var(--green);text-shadow:var(--glow-green);}
.q-feedback.miss{color:rgba(120,150,190,.7);}
#cdOverlay{position:fixed;inset:0;z-index:40;display:none;align-items:center;justify-content:center;pointer-events:none;}
.cd-num{font-family:'Orbitron',monospace;font-size:10rem;font-weight:900;animation:cdPop .85s ease-out forwards;}
@keyframes cdPop{0%{transform:scale(2.8);opacity:0;}25%{transform:scale(1);opacity:1;}75%{transform:scale(1);opacity:1;}100%{transform:scale(.65);opacity:0;}}
#resultsScreen .card{max-width:560px;}
.result-title{font-family:'Orbitron',monospace;font-size:1.4rem;font-weight:900;color:var(--yellow);text-align:center;letter-spacing:.12em;text-shadow:var(--glow-yellow);margin-bottom:.2rem;}
.result-sub{text-align:center;font-size:.58rem;color:var(--dim);letter-spacing:.25em;margin-bottom:1.2rem;font-family:'Share Tech Mono',monospace;}
.lb{width:100%;border-collapse:collapse;}
.lb th{font-family:'Orbitron',monospace;font-size:.5rem;color:rgba(80,130,190,.5);letter-spacing:.12em;padding:.3rem .4rem;text-align:left;border-bottom:1px solid rgba(0,100,200,.18);}
.lb td{padding:.48rem .4rem;font-size:.82rem;border-bottom:1px solid rgba(0,50,100,.2);font-family:'Rajdhani',sans-serif;font-weight:600;}
.lb tr:first-child td{background:rgba(255,215,0,.04);}
.lb .rank{font-family:'Orbitron',monospace;font-size:1rem;text-align:center;}
.lb .pname{font-weight:700;}
.lb .mono{font-family:'Share Tech Mono',monospace;font-size:.68rem;text-align:center;}
#touch-controls{position:fixed;bottom:0;left:0;right:0;z-index:25;display:none;padding:0 0 env(safe-area-inset-bottom,0) 0;justify-content:space-between;align-items:flex-end;pointer-events:none;height:160px;}
.tc-action{display:flex;flex-direction:column;gap:8px;align-items:center;padding:0 14px 18px;pointer-events:all;}
.tc-btn{border-radius:16px;display:flex;align-items:center;justify-content:center;user-select:none;-webkit-user-select:none;touch-action:none;-webkit-tap-highlight-color:transparent;font-weight:900;font-family:'Orbitron',monospace;transition:transform .08s,box-shadow .08s;-webkit-touch-callout:none;}
#tc-gas{width:92px;height:92px;font-size:2.2rem;border-radius:50%;background:radial-gradient(circle at 35% 35%,rgba(0,255,120,.2),rgba(0,120,60,.08));border:2.5px solid rgba(0,255,110,.55);color:rgba(0,255,120,.95);box-shadow:0 0 20px rgba(0,255,100,.15);}
#tc-brake{width:92px;height:92px;font-size:2.2rem;border-radius:50%;background:radial-gradient(circle at 35% 35%,rgba(255,80,80,.2),rgba(140,20,20,.08));border:2.5px solid rgba(255,50,50,.5);color:rgba(255,90,90,.9);box-shadow:0 0 20px rgba(255,50,50,.15);}
.tc-btn.pressed{transform:scale(.86);box-shadow:none!important;}
.tc-label{font-family:'Orbitron',monospace;font-size:.42rem;letter-spacing:.1em;opacity:.45;text-align:center;margin-top:4px;color:#fff;pointer-events:none;}
#gear-hud{position:fixed;bottom:175px;right:20px;font-family:'Orbitron',monospace;font-size:2.4rem;font-weight:900;color:rgba(255,220,50,.85);display:none;pointer-events:none;z-index:22;text-shadow:0 0 24px rgba(255,210,0,.6);}
::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:rgba(0,160,255,.25);border-radius:2px;}
.car-select-scroll{max-height:calc(100vh - 260px);overflow-y:auto;padding-right:4px;scrollbar-width:thin;}
</style>
</head>
<body>

<canvas id="bg"></canvas>
<div id="ping" class="ok">‚óè 0ms</div>

<!-- MENU -->
<div class="screen" id="s-menu">
  <div class="logo-wrap">
    <div class="logo-main">SAT BUKKY</div>
    <div class="logo-sub">f1 satellite racing quiz ¬∑ v12 (fixed)</div>
  </div>
  <div class="btn-row" style="flex-direction:column;gap:.75rem;width:100%;max-width:300px;">
    <button class="btn btn-green btn-full" onclick="go('s-create')">üöÄ &nbsp;CREATE ROOM</button>
    <button class="btn btn-cyan  btn-full" onclick="go('s-join')">üì° &nbsp;JOIN ROOM</button>
    <button class="btn btn-yellow btn-full" onclick="startSoloFlow()">‚ö° &nbsp;QUICK RACE (SOLO)</button>
  </div>
  <div style="margin-top:2rem;font-size:.55rem;color:rgba(80,110,160,.45);font-family:'Orbitron',monospace;letter-spacing:.12em;text-align:center;">
    UP TO 4 PILOTS ¬∑ 5 CHECKPOINTS ¬∑ REAL-TIME MULTIPLAYER
  </div>
</div>

<!-- CREATE ROOM -->
<div class="screen gone" id="s-create">
  <div class="logo-wrap" style="margin-bottom:1rem;">
    <div class="logo-main" style="font-size:1.6rem;">SAT BUKKY</div>
  </div>
  <div class="card" style="max-width:480px;">
    <div class="card-title">üöÄ CREATE ROOM</div>
    <div class="field">
      <label>CALLSIGN</label>
      <input id="c-name" type="text" placeholder="Enter your name‚Ä¶" maxlength="14">
    </div>
    <div class="field">
      <label>SELECT TRACK</label>
      <div class="track-row" id="track-row">
        <div class="trk-btn sel" data-t="0" onclick="selTrack(0)"><span class="trk-emoji">üá¨üáß</span>SILVERSTONE</div>
        <div class="trk-btn"     data-t="1" onclick="selTrack(1)"><span class="trk-emoji">üá≤üá®</span>MONACO</div>
        <div class="trk-btn"     data-t="2" onclick="selTrack(2)"><span class="trk-emoji">üáßüá™</span>SPA</div>
        <div class="trk-btn"     data-t="3" onclick="selTrack(3)"><span class="trk-emoji">üáØüáµ</span>SUZUKA</div>
        <div class="trk-btn"     data-t="4" onclick="selTrack(4)"><span class="trk-emoji">üáÆüáπ</span>MONZA</div>
        <div class="trk-btn"     data-t="5" onclick="selTrack(5)"><span class="trk-emoji">üáßüá∑</span>INTERLAGOS</div>
      </div>
    </div>
    <div class="err" id="c-err"></div>
    <div class="btn-row" style="flex-direction:column;">
      <button class="btn btn-green btn-full" onclick="proceedToCarSelect('create')">NEXT: CHOOSE CAR ‚Üí</button>
      <button class="btn btn-dim   btn-full" onclick="go('s-menu')">‚Üê BACK</button>
    </div>
  </div>
</div>

<!-- JOIN ROOM -->
<div class="screen gone" id="s-join">
  <div class="logo-wrap" style="margin-bottom:1rem;">
    <div class="logo-main" style="font-size:1.6rem;">SAT BUKKY</div>
  </div>
  <div class="card">
    <div class="card-title">üì° JOIN ROOM</div>
    <div class="field">
      <label>CALLSIGN</label>
      <input id="j-name" type="text" placeholder="Enter your name‚Ä¶" maxlength="14">
    </div>
    <div class="field">
      <label>ROOM CODE</label>
      <input id="j-code" type="text" placeholder="Enter 4-char code‚Ä¶" maxlength="6" style="letter-spacing:.4em;text-transform:uppercase;">
    </div>
    <div class="err" id="j-err"></div>
    <div class="btn-row" style="flex-direction:column;">
      <button class="btn btn-cyan btn-full" onclick="proceedToCarSelect('join')">NEXT: CHOOSE CAR ‚Üí</button>
      <button class="btn btn-dim  btn-full" onclick="go('s-menu')">‚Üê BACK</button>
    </div>
  </div>
</div>

<!-- CAR SELECT -->
<div class="screen gone" id="s-carselect">
  <div class="logo-wrap" style="margin-bottom:.8rem;">
    <div class="logo-main" style="font-size:1.4rem;">CHOOSE YOUR CAR</div>
    <div class="logo-sub">2025 F1 SEASON</div>
  </div>
  <div class="card" style="max-width:520px;padding:1.2rem;max-height:92vh;overflow-y:auto;">
    <div class="car-select-scroll">
      <div class="car-grid" id="car-grid"></div>
    </div>
    <div id="car-err" class="err"></div>
    <div class="btn-row" style="flex-direction:column;margin-top:.8rem;">
      <button class="btn btn-yellow btn-full" id="car-confirm-btn" onclick="confirmCarSelect()">START RACE ‚ñ∂</button>
      <button class="btn btn-dim btn-full" onclick="go('s-menu')">‚Üê BACK</button>
    </div>
  </div>
</div>

<!-- LOBBY -->
<div class="screen gone" id="s-lobby">
  <div class="logo-wrap" style="margin-bottom:.8rem;">
    <div class="logo-main" style="font-size:1.6rem;">SAT BUKKY</div>
  </div>
  <div class="card" style="max-width:460px;">
    <div class="card-title">üõ∏ LOBBY</div>
    <div style="text-align:center;font-family:'Orbitron',monospace;font-size:.52rem;color:var(--dim);letter-spacing:.2em;">ROOM CODE</div>
    <div class="code-box" id="lb-code">----</div>
    <div class="slot-list" id="lb-slots"></div>
    <div id="lb-host-ctrl" style="display:none;margin-top:.7rem;">
      <button class="btn btn-green btn-full" id="lb-start-btn" onclick="hostStartGame()">START RACE ‚ñ∂</button>
    </div>
    <div id="lb-guest-wait" style="display:none;text-align:center;font-family:'Orbitron',monospace;font-size:.58rem;color:var(--dim);letter-spacing:.1em;margin-top:.7rem;">WAITING FOR HOST‚Ä¶</div>
    <div style="margin-top:.7rem;">
      <button class="btn btn-dim btn-full" onclick="leaveRoom()">‚Üê LEAVE ROOM</button>
    </div>
  </div>
</div>

<canvas id="gameCanvas"></canvas>

<div id="hud">
  <div class="hud-top">
    <div class="hud-card" id="hud-me"></div>
    <div class="hud-center">
      <div class="hud-cp" id="hud-cp">CP 0/5</div>
      <div class="hud-time" id="hud-time">00:00.00</div>
    </div>
    <div class="hud-others" id="hud-others"></div>
  </div>
  <div class="boost-hud" id="boost-hud" style="display:none;">
    <div class="boost-label">‚ö° DRS/BOOST</div>
    <div class="boost-track"><div class="boost-fill" id="boost-fill"></div></div>
  </div>
  <div class="ctrl-hint" id="ctrl-hint">‚Üê ‚Üí STEER ¬∑ ‚Üë GAS ¬∑ ‚Üì BRAKE</div>
</div>
<div id="gear-hud">N</div>

<div id="touch-controls">
  <div class="tc-action" style="padding:0 14px 18px;">
    <div style="display:flex;flex-direction:column;align-items:center;">
      <div class="tc-btn" id="tc-brake">‚ñ† BRAKE</div>
      <div class="tc-label">BRAKE</div>
    </div>
  </div>
  <div class="tc-action" style="padding:0 0 18px 0;position:absolute;bottom:0;right:190px;">
    <div style="display:flex;flex-direction:column;align-items:center;">
      <div class="tc-btn" id="tc-gas">‚ñ≤ GAS</div>
      <div class="tc-label">GAS</div>
    </div>
  </div>
</div>

<div id="cdOverlay">
  <div class="cd-num" id="cd-num" style="color:var(--green);">3</div>
</div>

<div id="qOverlay">
  <div class="q-card">
    <div class="q-cp-label" id="q-cp">CHECKPOINT 1 / 5</div>
    <div class="q-timer" id="q-timer">10</div>
    <div class="q-text" id="q-text">‚Ä¶</div>
    <div class="q-opts">
      <button class="q-opt" id="q-a" onclick="answer(0)"><div class="ol">A</div><div class="ot" id="q-ta">‚Ä¶</div></button>
      <button class="q-opt" id="q-b" onclick="answer(1)"><div class="ol">B</div><div class="ot" id="q-tb">‚Ä¶</div></button>
    </div>
    <div class="q-feedback" id="q-fb"></div>
  </div>
</div>

<div class="screen gone" id="resultsScreen" style="z-index:60;">
  <div class="card" style="max-width:540px;">
    <div class="result-title" id="result-title">üèÅ RACE COMPLETE</div>
    <div class="result-sub">FINAL LEADERBOARD</div>
    <table class="lb">
      <thead><tr><th style="text-align:center;">#</th><th>PILOT</th><th style="text-align:center;">‚úì</th><th style="text-align:center;">‚ö°</th><th style="text-align:center;">TIME</th><th style="text-align:center;">STATUS</th></tr></thead>
      <tbody id="lb-body"></tbody>
    </table>
    <div style="margin-top:1.2rem;" class="btn-row">
      <button class="btn btn-green" onclick="playAgain()">üîÑ AGAIN</button>
      <button class="btn btn-cyan"  onclick="go('s-menu');cleanupGame()">üè† MENU</button>
    </div>
  </div>
</div>

<script>
/* ===== MERGED: V12 UI + V4 FIREBASE MULTIPLAYER ===== */

// ========== FIREBASE REFERENCES (from V4) ==========
let roomRef = null, roomListener = null, posRef = null, posPushInterval = null;
let pingInterval = null, pingEl = null;

// ========== STAR BACKGROUND (from V12) ==========
(function initBg(){
  const c=document.getElementById('bg');
  const cx=c.getContext('2d');
  let W,H,stars=[],nebulae=[],shooters=[],dustClouds=[];
  function mkNebula(){return{x:Math.random(),y:Math.random(),rx:Math.random()*.5+.25,ry:Math.random()*.35+.18,hue:Math.random()<.45?190+Math.random()*50:260+Math.random()*50,a:Math.random()*.1+.04,rot:Math.random()*Math.PI};}
  function resize(){
    W=c.width=innerWidth;H=c.height=innerHeight;stars=[];
    for(let i=0;i<400;i++)stars.push({x:Math.random()*W,y:Math.random()*H,r:Math.random()*.4+.08,a:Math.random()*.4+.08,s:Math.random()*.001+.0002,ph:Math.random()*Math.PI*2,layer:0});
    for(let i=0;i<160;i++){const hue=Math.random()<.3?210:Math.random()<.5?180:30;stars.push({x:Math.random()*W,y:Math.random()*H,r:Math.random()*1.2+.4,a:Math.random()*.65+.2,s:Math.random()*.002+.001,ph:Math.random()*Math.PI*2,layer:1,hue});}
    for(let i=0;i<35;i++)stars.push({x:Math.random()*W,y:Math.random()*H,r:Math.random()*2+1,a:.85+Math.random()*.15,s:Math.random()*.0015+.001,ph:Math.random()*Math.PI*2,layer:2,spike:true});
    nebulae=[];for(let i=0;i<7;i++)nebulae.push(mkNebula());
    dustClouds=[];for(let i=0;i<4;i++)dustClouds.push({x:Math.random()*W,y:Math.random()*H,r:Math.min(W,H)*(0.2+Math.random()*.3),a:0.04+Math.random()*.06,hue:200+Math.random()*80});
  }
  resize();window.addEventListener('resize',resize);
  let t=0;
  function draw(){
    cx.clearRect(0,0,W,H);
    const bg=cx.createLinearGradient(0,0,W*.4,H);
    bg.addColorStop(0,'#00010d');bg.addColorStop(.45,'#000510');bg.addColorStop(1,'#00020a');
    cx.fillStyle=bg;cx.fillRect(0,0,W,H);
    dustClouds.forEach(d=>{const gr=cx.createRadialGradient(d.x,d.y,0,d.x,d.y,d.r);gr.addColorStop(0,`hsla(${d.hue},60%,40%,${d.a})`);gr.addColorStop(.5,`hsla(${d.hue},40%,25%,${d.a*.4})`);gr.addColorStop(1,'transparent');cx.fillStyle=gr;cx.fillRect(d.x-d.r,d.y-d.r,d.r*2,d.r*2);});
    nebulae.forEach(n=>{cx.save();cx.translate(n.x*W,n.y*H);cx.rotate(n.rot);const gr=cx.createRadialGradient(0,0,0,0,0,n.rx*Math.max(W,H)*.5);gr.addColorStop(0,`hsla(${n.hue},80%,55%,${n.a})`);gr.addColorStop(.35,`hsla(${n.hue+25},65%,38%,${n.a*.5})`);gr.addColorStop(1,'transparent');cx.scale(1,n.ry/n.rx);cx.fillStyle=gr;cx.beginPath();cx.arc(0,0,n.rx*Math.max(W,H)*.5,0,Math.PI*2);cx.fill();cx.restore();});
    stars.forEach(s=>{const b=s.a*(0.55+0.45*Math.sin(t*s.s+s.ph));cx.globalAlpha=b;if(s.spike){cx.save();cx.shadowColor=s.hue?`hsl(${s.hue},80%,85%)`:'#b8d8ff';cx.shadowBlur=s.r*5;cx.fillStyle=s.hue?`hsl(${s.hue},70%,90%)`:'#dde8ff';cx.fillRect(s.x-s.r,s.y-.6,s.r*2,1.2);cx.fillRect(s.x-.6,s.y-s.r,1.2,s.r*2);cx.beginPath();cx.arc(s.x,s.y,s.r*.65,0,Math.PI*2);cx.fill();cx.restore();}else{cx.fillStyle=s.hue!=null?`hsl(${s.hue},65%,88%)`:'#d8eaff';cx.beginPath();cx.arc(s.x,s.y,s.r,0,Math.PI*2);cx.fill();}});
    cx.globalAlpha=1;
    if(Math.random()<.004&&shooters.length<5){const angle=Math.PI*.08+Math.random()*.28;shooters.push({x:Math.random()*W*.8,y:Math.random()*H*.35,vx:Math.cos(angle)*20,vy:Math.sin(angle)*11,life:1,len:90+Math.random()*80,hue:180+Math.random()*60});}
    shooters=shooters.filter(sh=>sh.life>0);
    shooters.forEach(sh=>{sh.x+=sh.vx;sh.y+=sh.vy;sh.life-=.016;const gr=cx.createLinearGradient(sh.x,sh.y,sh.x-sh.vx*(sh.len/20),sh.y-sh.vy*(sh.len/11));gr.addColorStop(0,`hsla(${sh.hue},90%,95%,${sh.life})`);gr.addColorStop(.6,`hsla(${sh.hue},80%,80%,${sh.life*.4})`);gr.addColorStop(1,'transparent');cx.strokeStyle=gr;cx.lineWidth=1.8;cx.beginPath();cx.moveTo(sh.x,sh.y);cx.lineTo(sh.x-sh.vx*(sh.len/20),sh.y-sh.vy*(sh.len/11));cx.stroke();});
    t++;requestAnimationFrame(draw);
  }
  draw();
})();

// ========== AUDIO (from V12) ==========
let audioCtx=null,masterGain=null,audioStarted=false;
function initAudio(){
  if(audioStarted)return;
  try{
    audioCtx=new(window.AudioContext||window.webkitAudioContext)();
    masterGain=audioCtx.createGain();
    masterGain.gain.value=0.32;
    masterGain.connect(audioCtx.destination);
    audioStarted=true;
  }catch(e){console.warn('Audio init failed:',e);}
}
function playBeep(freq,dur,vol,type){
  if(!audioCtx)return;
  const o=audioCtx.createOscillator();const g=audioCtx.createGain();
  o.type=type||'sine';o.connect(g);g.connect(masterGain||audioCtx.destination);
  o.frequency.value=freq;g.gain.value=vol||0.3;
  g.gain.setTargetAtTime(0,audioCtx.currentTime+dur*.7,0.05);
  o.start();o.stop(audioCtx.currentTime+dur+0.1);
}
function playCountdownBeep(n){
  if(!audioCtx)return;
  if(n>0){playBeep(440,.14,.5,'sine');playBeep(880,.07,.12,'sine');}
  else{
    playBeep(660,.08,.6,'sawtooth');
    setTimeout(()=>playBeep(880,.08,.5,'sawtooth'),80);
    setTimeout(()=>playBeep(1100,.22,.55,'sawtooth'),160);
  }
}
function playCheckpointSound(correct){
  if(!audioCtx)return;
  if(correct){
    playBeep(523,.07,.3,'triangle');
    setTimeout(()=>playBeep(659,.07,.3,'triangle'),90);
    setTimeout(()=>playBeep(784,.07,.3,'triangle'),180);
    setTimeout(()=>playBeep(1047,.18,.4,'triangle'),270);
  }else{
    playBeep(280,.12,.3,'sawtooth');
    setTimeout(()=>playBeep(220,.18,.25,'sawtooth'),120);
  }
}
function stopEngineSound(){}
function startEngineSound(){}
function updateEngineSound(){}

// ========== SCREEN NAV (from V12) ==========
let _cur='s-menu';
function go(id){
  document.getElementById(_cur).classList.add('out');
  setTimeout(()=>{
    document.getElementById(_cur).classList.add('gone');
    document.getElementById(_cur).classList.remove('out');
    _cur=id;
    const el=document.getElementById(id);
    el.classList.remove('gone');
    el.style.opacity=0;el.style.transform='scale(.97)';
    requestAnimationFrame(()=>requestAnimationFrame(()=>{el.style.opacity='';el.style.transform='';}));
  },300);
}

// ========== F1 CARS (from V12) ==========
const F1_CARS = [
  {id:'rb22', team:'Red Bull Racing', model:'RB22', primaryColor:'#1E41FF', secondaryColor:'#CC1E4A', accentColor:'#FFD700', bodyColor:'#0B2265', noseColor:'#1E41FF', livery:'redbull', emoji:'üîµ', driver:'Verstappen / P√©rez', num:'1', description:'Dominant triple-champion challenger'},
  {id:'w17', team:'Mercedes-AMG', model:'W17', primaryColor:'#00D2BE', secondaryColor:'#000000', accentColor:'#FFFFFF', bodyColor:'#00D2BE', noseColor:'#000000', livery:'mercedes', emoji:'ü©µ', driver:'Russell / Antonelli', num:'63', description:'Petronas teal speed machine'},
  {id:'sf26', team:'Ferrari', model:'SF-26', primaryColor:'#DC0000', secondaryColor:'#FFD700', accentColor:'#FFFFFF', bodyColor:'#DC0000', noseColor:'#DC0000', livery:'ferrari', emoji:'üî¥', driver:'Leclerc / Hamilton', num:'16', description:'Prancing Horse Italian passion'},
  {id:'mcl40', team:'McLaren', model:'MCL40', primaryColor:'#FF8000', secondaryColor:'#000000', accentColor:'#FFFFFF', bodyColor:'#FF8000', noseColor:'#000000', livery:'mclaren', emoji:'üü†', driver:'Norris / Piastri', num:'4', description:'Papaya power, papaya glory'},
  {id:'amr25', team:'Aston Martin', model:'AMR25', primaryColor:'#006F62', secondaryColor:'#CEDC00', accentColor:'#FFFFFF', bodyColor:'#006F62', noseColor:'#006F62', livery:'astonmartin', emoji:'üü¢', driver:'Alonso / Stroll', num:'14', description:'British Racing Green legend'},
  {id:'rb21', team:'RB (VCARB)', model:'VCARB 02', primaryColor:'#6592FF', secondaryColor:'#CC1E4A', accentColor:'#FFFFFF', bodyColor:'#1A2CB8', noseColor:'#3050D0', livery:'alphatauri', emoji:'üî∑', driver:'Tsunoda / Lawson', num:'22', description:'Junior Red Bull power'},
  {id:'c25', team:'Kick Sauber', model:'C25', primaryColor:'#52E252', secondaryColor:'#000000', accentColor:'#FFFFFF', bodyColor:'#1A1A1A', noseColor:'#52E252', livery:'sauber', emoji:'üíö', driver:'H√ºlkenberg / Bortoleto', num:'27', description:'Audi-powered future contender'},
  {id:'a525', team:'Alpine', model:'A525', primaryColor:'#FF87BC', secondaryColor:'#0055A5', accentColor:'#FFFFFF', bodyColor:'#0055A5', noseColor:'#FF87BC', livery:'alpine', emoji:'ü©∑', driver:'Gasly / Doohan', num:'10', description:'French finesse and flair'},
];

// ========== CAR SELECT (from V12) ==========
let selectedCarIdx=0;
let carSelectMode='solo';

function buildCarGrid(){
  const btn=document.getElementById('car-confirm-btn');
  if(btn){
    if(carSelectMode==='join') btn.textContent='JOIN RACE ‚ñ∂';
    else if(carSelectMode==='create') btn.textContent='CREATE & START ‚ñ∂';
    else btn.textContent='START RACE ‚ñ∂';
  }
  const grid=document.getElementById('car-grid');
  grid.innerHTML='';
  F1_CARS.forEach((car,i)=>{
    const card=document.createElement('div');
    card.className='car-card'+(i===selectedCarIdx?' sel':'');
    card.onclick=()=>{
      selectedCarIdx=i;
      document.querySelectorAll('.car-card').forEach((c,j)=>c.classList.toggle('sel',j===i));
    };
    const cv=document.createElement('canvas');
    cv.className='car-canvas';cv.width=200;cv.height=70;
    card.appendChild(cv);
    const nameDiv=document.createElement('div');
    nameDiv.className='car-name';nameDiv.style.color=car.primaryColor;nameDiv.textContent=car.model;
    const teamDiv=document.createElement('div');
    teamDiv.className='car-team';teamDiv.textContent=car.team;
    const driverDiv=document.createElement('div');
    driverDiv.style.cssText='font-size:.42rem;color:rgba(140,180,255,.5);margin-top:.1rem;';
    driverDiv.textContent=car.driver;
    card.appendChild(nameDiv);card.appendChild(teamDiv);card.appendChild(driverDiv);
    grid.appendChild(card);
    setTimeout(()=>drawCarPreview(cv,car),50);
  });
}

function drawCarPreview(cv,car){
  const c=cv.getContext('2d');
  const W=cv.width,H=cv.height;
  c.clearRect(0,0,W,H);
  c.fillStyle='rgba(0,5,20,.6)';c.fillRect(0,0,W,H);
  c.save();c.translate(W/2,H/2);c.scale(0.8,0.8);
  drawF1CarShape(c,car,20);
  c.restore();
}

function drawF1CarShape(c,car,size){
  const C=car.primaryColor;
  const C2=car.secondaryColor;
  const CA=car.accentColor||'#FFFFFF';
  const livery=car.livery;
  c.save();
  c.globalAlpha=.25;c.fillStyle='#000';c.beginPath();c.ellipse(0,size*.2,size*1.1,size*.35,0,0,Math.PI*2);c.fill();
  c.globalAlpha=1;
  c.fillStyle=C;c.fillRect(-size*.7,size*.7,size*1.4,size*.12);
  c.fillStyle=C2.length>2?C2:'#111';c.fillRect(-size*.7,size*.82,size*1.4,size*.06);
  [[-size*.7,size*.7],[size*.6,size*.7]].forEach(([x,y])=>{c.fillStyle=C;c.fillRect(x,y,size*.1,size*.26);});
  c.fillStyle='#111';c.beginPath();c.moveTo(-size*.4,size*.6);c.lineTo(size*.4,size*.6);c.lineTo(size*.55,size*.7);c.lineTo(-size*.55,size*.7);c.closePath();c.fill();
  [[-size*.65,size*.38],[size*.65,size*.38]].forEach(([tx,ty])=>{
    const ftw=size*.48,fth=size*.28;
    const tgr=c.createRadialGradient(tx-ftw*.15,ty-fth*.15,0,tx,ty,ftw*.55);
    tgr.addColorStop(0,'#555');tgr.addColorStop(.7,'#222');tgr.addColorStop(1,'#111');
    c.fillStyle=tgr;c.beginPath();c.ellipse(tx,ty,ftw*.55,fth*.55,0,0,Math.PI*2);c.fill();
    c.fillStyle='#ddd';c.beginPath();c.ellipse(tx,ty,ftw*.44,fth*.44,0,0,Math.PI*2);c.fill();
    c.fillStyle='#111';c.beginPath();c.ellipse(tx,ty,ftw*.36,fth*.36,0,0,Math.PI*2);c.fill();
    c.fillStyle='#ccc';c.beginPath();c.ellipse(tx,ty,ftw*.25,fth*.25,0,0,Math.PI*2);c.fill();
    c.fillStyle='#555';c.beginPath();c.arc(tx,ty,ftw*.09,0,Math.PI*2);c.fill();
    c.strokeStyle='#aaa';c.lineWidth=1.2;
    for(let s=0;s<5;s++){const a=s*Math.PI*2/5;c.beginPath();c.moveTo(tx+Math.cos(a)*ftw*.11,ty+Math.sin(a)*fth*.11);c.lineTo(tx+Math.cos(a)*ftw*.42,ty+Math.sin(a)*fth*.42);c.stroke();}
  });
  c.fillStyle=C;
  c.beginPath();c.moveTo(-size*.75,-size*.1);c.lineTo(-size*.2,-size*.1);c.lineTo(-size*.15,size*.35);c.lineTo(-size*.75,size*.35);c.closePath();c.fill();
  c.beginPath();c.moveTo(size*.75,-size*.1);c.lineTo(size*.2,-size*.1);c.lineTo(size*.15,size*.35);c.lineTo(size*.75,size*.35);c.closePath();c.fill();
  if(livery==='redbull'){
    c.fillStyle='#CC1E4A';
    c.beginPath();c.moveTo(-size*.75,size*.05);c.lineTo(-size*.2,size*.05);c.lineTo(-size*.15,size*.2);c.lineTo(-size*.75,size*.2);c.closePath();c.fill();
    c.beginPath();c.moveTo(size*.75,size*.05);c.lineTo(size*.2,size*.05);c.lineTo(size*.15,size*.2);c.lineTo(size*.75,size*.2);c.closePath();c.fill();
    c.fillStyle='#FFD700';c.fillRect(-size*.72,-size*.06,size*1.44,size*.04);
  } else if(livery==='mercedes'){
    c.fillStyle='#000';
    c.beginPath();c.moveTo(-size*.75,-size*.1);c.lineTo(-size*.2,-size*.1);c.lineTo(-size*.2,size*.05);c.lineTo(-size*.75,size*.05);c.closePath();c.fill();
    c.beginPath();c.moveTo(size*.75,-size*.1);c.lineTo(size*.2,-size*.1);c.lineTo(size*.2,size*.05);c.lineTo(size*.75,size*.05);c.closePath();c.fill();
  } else if(livery==='ferrari'){
    c.fillStyle='#FFD700';c.fillRect(-size*.72,size*.08,size*1.44,size*.05);
    c.fillStyle='rgba(255,255,255,.2)';c.fillRect(-size*.72,-size*.06,size*1.44,size*.04);
  } else if(livery==='mclaren'){
    c.fillStyle='#000';c.fillRect(-size*.72,size*.08,size*1.44,size*.18);
    c.fillStyle='rgba(255,255,255,.15)';c.fillRect(-size*.72,-size*.06,size*1.44,size*.04);
  }
  const bodyGr=c.createLinearGradient(-size*.15,-size*.55,size*.15,size*.3);
  bodyGr.addColorStop(0,lightenHex(C,40));bodyGr.addColorStop(.5,C);bodyGr.addColorStop(1,darkenHex(C,30));
  c.fillStyle=bodyGr;
  c.beginPath();
  c.moveTo(0,-size*.95);
  c.bezierCurveTo(size*.18,-size*.88,size*.22,-size*.55,size*.22,-size*.2);
  c.lineTo(size*.22,size*.5);c.lineTo(-size*.22,size*.5);
  c.lineTo(-size*.22,-size*.2);
  c.bezierCurveTo(-size*.22,-size*.55,-size*.18,-size*.88,0,-size*.95);
  c.closePath();c.fill();
  c.globalAlpha=.25;c.fillStyle='rgba(255,255,255,.7)';
  c.beginPath();c.moveTo(0,-size*.9);c.bezierCurveTo(size*.08,-size*.8,size*.1,-size*.5,size*.08,-size*.15);c.lineTo(-size*.08,-size*.15);c.bezierCurveTo(-size*.1,-size*.5,-size*.08,-size*.8,0,-size*.9);c.closePath();c.fill();
  c.globalAlpha=1;
  c.fillStyle='rgba(0,0,0,.85)';
  c.beginPath();c.ellipse(0,-size*.2,size*.18,size*.28,0,0,Math.PI*2);c.fill();
  c.fillStyle='rgba(0,150,255,.3)';
  c.beginPath();c.ellipse(0,-size*.22,size*.12,size*.2,0,0,Math.PI*2);c.fill();
  c.fillStyle='rgba(255,255,255,.2)';
  c.beginPath();c.ellipse(-size*.04,-size*.28,size*.05,size*.08,Math.PI*.3,0,Math.PI*2);c.fill();
  c.strokeStyle=CA;c.lineWidth=3;
  c.beginPath();c.ellipse(0,-size*.18,size*.2,size*.1,-Math.PI*.1,0,Math.PI*2);c.stroke();
  c.fillStyle=C;c.fillRect(-size*.03,-size*.35,size*.06,size*.28);
  [[-size*.5,-size*.5],[size*.5,-size*.5]].forEach(([tx,ty])=>{
    const ftw=size*.38,fth=size*.24;
    const tgr=c.createRadialGradient(tx-ftw*.15,ty-fth*.15,0,tx,ty,ftw*.5);
    tgr.addColorStop(0,'#555');tgr.addColorStop(.7,'#222');tgr.addColorStop(1,'#111');
    c.fillStyle=tgr;c.beginPath();c.ellipse(tx,ty,ftw*.5,fth*.5,0,0,Math.PI*2);c.fill();
    c.fillStyle='#ddd';c.beginPath();c.ellipse(tx,ty,ftw*.38,fth*.38,0,0,Math.PI*2);c.fill();
    c.fillStyle='#111';c.beginPath();c.ellipse(tx,ty,ftw*.28,fth*.28,0,0,Math.PI*2);c.fill();
    c.fillStyle='#ccc';c.beginPath();c.ellipse(tx,ty,ftw*.18,fth*.18,0,0,Math.PI*2);c.fill();
    c.fillStyle='#555';c.beginPath();c.arc(tx,ty,ftw*.07,0,Math.PI*2);c.fill();
    c.strokeStyle='#aaa';c.lineWidth=1;
    for(let s=0;s<5;s++){const a=s*Math.PI*2/5;c.beginPath();c.moveTo(tx+Math.cos(a)*ftw*.09,ty+Math.sin(a)*fth*.09);c.lineTo(tx+Math.cos(a)*ftw*.35,ty+Math.sin(a)*fth*.35);c.stroke();}
  });
  [[-size*.22,-size*.32],[ size*.22,-size*.32]].forEach(([ax,ay])=>{
    const tx=(ax<0?-size*.5:size*.5),ty=-size*.5;
    c.strokeStyle=CA+'88';c.lineWidth=2;
    c.beginPath();c.moveTo(ax,ay);c.lineTo(tx,ty);c.stroke();
  });
  c.fillStyle=C;c.fillRect(-size*.78,-size*.95,size*1.56,size*.11);
  c.fillStyle=C+'cc';c.fillRect(-size*.7,-size*.84,size*1.4,size*.07);
  c.fillStyle=C;
  [[-size*.78,-size*.95],[size*.68,-size*.95]].forEach(([ex,ey])=>c.fillRect(ex,ey,size*.1,size*.28));
  c.beginPath();c.moveTo(-size*.06,-size*.97);c.lineTo(size*.06,-size*.97);c.lineTo(size*.05,-size*.85);c.lineTo(-size*.05,-size*.85);c.closePath();c.fill();
  [[-size*.76,-size*.91,'#ff3b8a'],[size*.76,-size*.91,'#00cfff']].forEach(([lx,ly,lc])=>{
    c.fillStyle=lc;c.beginPath();c.arc(lx,ly,3,0,Math.PI*2);c.fill();
  });
  c.fillStyle='rgba(255,255,255,0.9)';
  c.font=`bold ${size*.3}px Orbitron,monospace`;
  c.textAlign='center';c.textBaseline='middle';
  c.fillText(car.num,0,size*.15);
  if(car._flame&&car._flame>0){
    const fg=c.createLinearGradient(0,size*.7,0,size*1.4);
    fg.addColorStop(0,'rgba(255,100,0,.9)');fg.addColorStop(.5,'rgba(255,200,0,.6)');fg.addColorStop(1,'transparent');
    c.globalAlpha=car._flame;c.fillStyle=fg;
    c.beginPath();c.ellipse(0,size*.95,size*.1+Math.random()*size*.06,size*.5+Math.random()*size*.2,0,0,Math.PI*2);c.fill();
    c.globalAlpha=1;
  }
  c.restore();
}

function lightenHex(hex,amount){
  const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
  return`#${Math.min(255,r+amount).toString(16).padStart(2,'0')}${Math.min(255,g+amount).toString(16).padStart(2,'0')}${Math.min(255,b+amount).toString(16).padStart(2,'0')}`;
}
function darkenHex(hex,amount){
  const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
  return`#${Math.max(0,r-amount).toString(16).padStart(2,'0')}${Math.max(0,g-amount).toString(16).padStart(2,'0')}${Math.max(0,b-amount).toString(16).padStart(2,'0')}`;
}

// ========== TRACK SELECT (from V12) ==========
let selTrackIdx=0;
function selTrack(i){
  selTrackIdx=i;
  document.querySelectorAll('.trk-btn').forEach(b=>b.classList.toggle('sel',+b.dataset.t===i));
}

// ========== CAR SELECT FLOW (from V12) ==========
function proceedToCarSelect(mode){
  carSelectMode=mode;
  if(mode==='create'){
    const name=document.getElementById('c-name').value.trim();
    if(!name){document.getElementById('c-err').textContent='Enter your callsign!';return;}
    document.getElementById('c-err').textContent='';
    selectedCarIdx=0;buildCarGrid();go('s-carselect');
  } else if(mode==='join'){
    const name=document.getElementById('j-name').value.trim();
    const code=document.getElementById('j-code').value.trim().toUpperCase();
    if(!name){document.getElementById('j-err').textContent='Enter your callsign!';return;}
    if(!code){document.getElementById('j-err').textContent='Enter room code!';return;}
    document.getElementById('j-err').textContent='';
    selectedCarIdx=0;buildCarGrid();go('s-carselect');
  } else {
    selectedCarIdx=0;buildCarGrid();go('s-carselect');
  }
}

function startSoloFlow(){
  carSelectMode='solo';
  selectedCarIdx=0;
  buildCarGrid();
  go('s-carselect');
}

function confirmCarSelect(){
  initAudio();
  const car=F1_CARS[selectedCarIdx];
  if(!car){document.getElementById('car-err').textContent='Please select a car!';return;}
  document.getElementById('car-err').textContent='';
  if(carSelectMode==='solo') soloRace();
  else if(carSelectMode==='create') createRoom();
  else joinRoom();
}

// ========== MULTIPLAYER (from V4 with V12 naming) ==========
let room = null, myId = null, amHost = false;
const PC = ['#00d4ff','#ff3b8a','#ffe34d','#00ff9d','#ff8000','#cc44ff','#52e252','#ff87bc'];
const PE = ['üîµ','üî¥','üü†','üü¢','üü°','üü£','üíö','ü©∑'];

function rndCode(){return Math.random().toString(36).substr(2,4).toUpperCase();}

function listenRoom(code){
  if(roomListener && roomRef){roomRef.off('value', roomListener);}
  roomRef = db.ref('rooms/' + code);
  roomListener = roomRef.on('value', snap => {
    if(!snap.exists()) return;
    const r = snap.val();
    room = r;
    if(r.state === 'lobby') renderLobby();
    if(r.state === 'racing' && !gameOn) beginGame();
    if(r.state === 'done') showResults();
  });
  if(amHost) roomRef.onDisconnect().update({state:'done'});
  else roomRef.child('players/' + myId).onDisconnect().remove();
}

function listenPositions(code){
  posRef = db.ref('pos/' + code);
  posRef.on('value', snap => {
    if(!snap.exists() || !players) return;
    const all = snap.val();
    Object.entries(all).forEach(([pid, pd]) => {
      if(pid === myId) return;
      const gp = players.find(p => p.id === pid);
      if(!gp) return;
      gp._tgtX = pd.x;
      gp._tgtY = pd.y;
      gp._tgtAng = pd.ang;
      gp._remoteT = pd.t;
      gp.boost = pd.boost || false;
      gp.checkpt = pd.cp || 0;
      gp.fin = pd.fin || false;
      if(gp.x === 0 && gp.y === 0){gp.x=pd.x; gp.y=pd.y; gp.ang=pd.ang;}
    });
  });
}

function startPosPush(code){
  if(posPushInterval) clearInterval(posPushInterval);
  posPushInterval = setInterval(() => {
    if(!myP || !gameOn) return;
    db.ref('pos/' + code + '/' + myId).set({
      t: myP.t,
      x: Math.round(myP.x),
      y: Math.round(myP.y),
      ang: +myP.ang.toFixed(3),
      boost: myP.boost,
      cp: myP.checkpt,
      fin: myP.fin || false,
    });
  }, 50);
}

function stopPosPush(){
  if(posPushInterval){clearInterval(posPushInterval); posPushInterval=null;}
}

function startPing(){
  pingEl = document.getElementById('ping');
  if(pingInterval) clearInterval(pingInterval);
  pingInterval = setInterval(() => {
    if(!room || room.code === 'SOLO') return;
    const t0 = performance.now();
    db.ref('ping/' + room.code).set(firebase.database.ServerValue.TIMESTAMP).then(() => {
      const ms = Math.round(performance.now() - t0);
      if(pingEl){
        pingEl.textContent = `‚óè ${ms}ms`;
        pingEl.className = ms < 120 ? 'ok' : (ms < 300 ? 'lag' : 'bad');
      }
    });
  }, 3000);
}

function createRoom(){
  const name = document.getElementById('c-name').value.trim();
  if(!name){document.getElementById('c-err').textContent='Enter your callsign!'; return;}
  document.getElementById('c-err').textContent='';
  myId = 'p' + Date.now(); amHost = true;
  const code = rndCode();
  const car = F1_CARS[selectedCarIdx];
  const roomData = {
    code, host: myId, track: selTrackIdx, state: 'lobby',
    players: {
      [myId]: {id: myId, name, color: car.primaryColor, emoji: car.emoji, carId: car.id, score:0, boosts:0, ftime:0, checkpt:0}
    }
  };
  db.ref('rooms/' + code).set(roomData)
    .then(() => {
      room = roomData;
      listenRoom(code);
      openLobby();
    })
    .catch(e => {document.getElementById('c-err').textContent='Error: '+e.message;});
}

function joinRoom(){
  const name = document.getElementById('j-name').value.trim();
  const code = document.getElementById('j-code').value.trim().toUpperCase();
  if(!name){document.getElementById('j-err').textContent='Enter callsign!'; return;}
  if(!code){document.getElementById('j-err').textContent='Enter room code!'; return;}
  document.getElementById('j-err').textContent = 'Searching‚Ä¶';
  db.ref('rooms/' + code).once('value').then(snap => {
    if(!snap.exists()){document.getElementById('j-err').textContent='Room not found!'; return;}
    const r = snap.val();
    if(r.state !== 'lobby'){document.getElementById('j-err').textContent='Race already started!'; return;}
    const count = Object.keys(r.players || {}).length;
    if(count >= 4){document.getElementById('j-err').textContent='Room full (max 4)!'; return;}
    document.getElementById('j-err').textContent = '';
    myId = 'p' + Date.now(); amHost = false;
    const car = F1_CARS[selectedCarIdx];
    const idx = count;
    db.ref('rooms/' + code + '/players/' + myId).set(
      {id:myId, name, color:car.primaryColor, emoji:car.emoji, carId:car.id, score:0, boosts:0, ftime:0, checkpt:0}
    ).then(() => {
      room = r;
      listenRoom(code);
      openLobby();
    });
  }).catch(e => {document.getElementById('j-err').textContent='Error: '+e.message;});
}

function openLobby(){
  renderLobby(); go('s-lobby');
}

function renderLobby(){
  document.getElementById('lb-code').textContent = room.code;
  const list = document.getElementById('lb-slots'); list.innerHTML = '';
  const plist = Object.values(room.players || {});
  for(let i=0; i<4; i++){
    const p = plist[i];
    if(p){
      const car = F1_CARS.find(c=>c.id===p.carId) || F1_CARS[0];
      list.innerHTML += `<div class="slot"><div class="slot-dot" style="background:${p.color};color:${p.color};"></div><span style="color:${p.color};font-weight:700;">${p.emoji} ${p.name}</span><span style="font-size:.5rem;color:var(--dim);margin-left:.3rem;">${car.model}</span>${p.id===room.host?'<span class="slot-host-badge">HOST</span>':''}</div>`;
    }else{
      list.innerHTML += `<div class="slot empty"><div class="slot-dot" style="background:#223;color:#223;"></div>Waiting for pilot‚Ä¶</div>`;
    }
  }
  if(amHost){
    document.getElementById('lb-guest-wait').style.display='none';
    document.getElementById('lb-host-ctrl').style.display='block';
    document.getElementById('lb-start-btn').textContent = 'START RACE ‚ñ∂' + (plist.length < 2 ? ' (YOU ONLY)' : '');
  }else{
    document.getElementById('lb-host-ctrl').style.display='none';
    document.getElementById('lb-guest-wait').style.display='block';
  }
}

function hostStartGame(){
  if(!amHost) return;
  roomRef.update({state:'racing'});
}

function leaveRoom(){
  stopPosPush(); stopPing();
  if(posRef){posRef.off(); posRef=null;}
  if(roomListener && roomRef){roomRef.off('value', roomListener);}
  if(room && room.code !== 'SOLO'){
    if(amHost) roomRef.remove();
    else if(myId) roomRef.child('players/' + myId).remove();
    db.ref('pos/' + room.code).remove();
  }
  room=null; myId=null; amHost=false; roomRef=null;
  cleanupGame(); go('s-menu');
}

function stopPing(){
  if(pingInterval){clearInterval(pingInterval); pingInterval=null;}
  if(pingEl) pingEl.style.opacity='0';
}

// ========== SOLO RACE (from V12) ==========
function soloRace(){
  myId='solo'; amHost=true;
  const car = F1_CARS[selectedCarIdx];
  room = {
    code:'SOLO', host:myId, track:selTrackIdx, state:'racing',
    players: {
      solo: {id:'solo', name:'YOU', color:car.primaryColor, emoji:car.emoji, carId:car.id, score:0, boosts:0, ftime:0, checkpt:0},
      cpu1:{id:'cpu1', name:'SPUTNIK', color:'#ff3b8a', emoji:'üöÄ', carId:'rb22', score:0, boosts:0, ftime:0, checkpt:0, cpu:true},
      cpu2:{id:'cpu2', name:'KEPLER', color:'#ffe34d', emoji:'‚òÑÔ∏è', carId:'sf26', score:0, boosts:0, ftime:0, checkpt:0, cpu:true},
    }
  };
  beginGame();
}

// ========== TRACK DEFINITIONS (from V12) ==========
const TRACK_DEFS = [
  {name:'SILVERSTONE', bg:'#03080f', nebula:'#071520', road:'#252528', roadEdge:'#38383f', runoff:'#1a2535', grass:'#0a1a08', kerb1:'#f0f0f0', kerb2:'#cc0000', cpColor:'#00cfff', accentColor:'#00cfff', barrierColor:'#4a4a5a', grandstandColor:'#1a2040', treeColor:'#0d3210', sceneryTint:'#00cfff', pitColor:'#1e1e28',
    ctrl:[[.50,.09],[.56,.085],[.63,.082],[.70,.082],[.77,.085],[.84,.09],[.89,.10],[.93,.13],[.95,.18],[.96,.24],[.96,.30],[.94,.36],[.91,.41],[.87,.44],[.82,.46],[.78,.44],[.74,.41],[.71,.44],[.69,.48],[.70,.53],[.73,.57],[.77,.60],[.82,.62],[.88,.62],[.91,.65],[.93,.70],[.93,.76],[.90,.81],[.86,.84],[.82,.86],[.76,.87],[.68,.88],[.60,.87],[.54,.85],[.50,.82],[.46,.82],[.40,.84],[.34,.85],[.28,.83],[.22,.79],[.17,.73],[.13,.67],[.11,.61],[.12,.55],[.15,.50],[.18,.44],[.16,.38],[.13,.32],[.10,.24],[.10,.17],[.13,.12],[.18,.09],[.26,.085],[.34,.085],[.42,.087],[.50,.09]]},
  {name:'MONACO', bg:'#0d0a06', nebula:'#1a1408', road:'#2a241c', roadEdge:'#44382a', runoff:'#1a1410', grass:'#0e0c08', kerb1:'#ff0000', kerb2:'#ffffff', cpColor:'#ff7300', accentColor:'#ffaa00', barrierColor:'#7a7060', grandstandColor:'#3a2010', treeColor:'#0e3408', sceneryTint:'#ff7300', pitColor:'#2a2018',
    ctrl:[[.50,.10],[.56,.09],[.62,.088],[.68,.088],[.73,.09],[.78,.10],[.83,.12],[.87,.16],[.88,.22],[.86,.28],[.82,.32],[.78,.34],[.74,.32],[.70,.28],[.68,.24],[.70,.19],[.73,.16],[.75,.12],[.74,.08],[.70,.06],[.64,.055],[.56,.056],[.48,.060],[.42,.068],[.36,.080],[.30,.10],[.26,.14],[.24,.20],[.23,.28],[.24,.36],[.27,.44],[.31,.51],[.36,.58],[.41,.63],[.46,.67],[.50,.68],[.54,.65],[.58,.61],[.63,.58],[.68,.60],[.73,.65],[.77,.70],[.78,.76],[.76,.82],[.72,.87],[.66,.90],[.58,.91],[.50,.90],[.42,.88],[.34,.83],[.28,.76],[.24,.68],[.21,.59],[.20,.50],[.20,.38],[.21,.27],[.24,.17],[.28,.12],[.34,.09],[.40,.085],[.46,.088],[.50,.10]]},
  {name:'SPA', bg:'#030c06', nebula:'#071510', road:'#22241e', roadEdge:'#363830', runoff:'#0e1810', grass:'#081808', kerb1:'#ff0000', kerb2:'#ffffff', cpColor:'#00ff9d', accentColor:'#00ff9d', barrierColor:'#4a4a4a', grandstandColor:'#102818', treeColor:'#0d3810', sceneryTint:'#00ff9d', pitColor:'#1a2018',
    ctrl:[[.50,.08],[.57,.076],[.64,.074],[.71,.075],[.78,.078],[.84,.083],[.89,.092],[.93,.105],[.95,.13],[.96,.16],[.95,.20],[.92,.25],[.89,.29],[.85,.32],[.80,.34],[.76,.35],[.72,.355],[.68,.355],[.64,.355],[.60,.36],[.56,.38],[.54,.42],[.55,.47],[.58,.51],[.62,.54],[.68,.56],[.74,.57],[.80,.56],[.85,.54],[.88,.50],[.90,.45],[.90,.39],[.88,.33],[.89,.62],[.88,.68],[.85,.74],[.80,.79],[.74,.83],[.68,.86],[.62,.88],[.56,.88],[.50,.87],[.44,.85],[.38,.82],[.32,.78],[.27,.73],[.22,.66],[.18,.60],[.15,.53],[.13,.46],[.12,.39],[.13,.32],[.14,.25],[.12,.18],[.10,.12],[.12,.09],[.17,.08],[.23,.078],[.30,.076],[.37,.074],[.44,.075],[.50,.08]]},
  {name:'SUZUKA', bg:'#04080d', nebula:'#081018', road:'#202228', roadEdge:'#303240', runoff:'#101820', grass:'#081408', kerb1:'#ff3300', kerb2:'#ffffff', cpColor:'#cc44ff', accentColor:'#cc44ff', barrierColor:'#505060', grandstandColor:'#1a1840', treeColor:'#0a3012', sceneryTint:'#cc44ff', pitColor:'#181828',
    ctrl:[[.50,.09],[.57,.086],[.64,.084],[.71,.087],[.77,.092],[.83,.10],[.87,.115],[.90,.14],[.91,.18],[.90,.23],[.88,.27],[.84,.31],[.80,.34],[.76,.35],[.72,.33],[.68,.30],[.65,.26],[.63,.22],[.64,.18],[.66,.15],[.68,.13],[.72,.11],[.76,.10],[.80,.10],[.83,.12],[.86,.15],[.88,.20],[.87,.27],[.84,.32],[.80,.38],[.75,.42],[.70,.46],[.65,.48],[.60,.48],[.55,.46],[.52,.42],[.50,.38],[.49,.33],[.50,.28],[.52,.22],[.55,.17],[.59,.13],[.64,.10],[.58,.42],[.54,.46],[.52,.51],[.53,.56],[.56,.60],[.60,.63],[.64,.64],[.68,.62],[.72,.60],[.76,.57],[.79,.53],[.80,.48],[.79,.42],[.77,.56],[.74,.62],[.70,.68],[.65,.72],[.60,.74],[.54,.75],[.48,.74],[.42,.71],[.37,.67],[.33,.61],[.30,.55],[.28,.48],[.28,.41],[.30,.34],[.33,.28],[.37,.22],[.41,.17],[.46,.13],[.50,.09]]},
  {name:'MONZA', bg:'#060408', nebula:'#120810', road:'#1e1e20', roadEdge:'#32323a', runoff:'#121015', grass:'#060e05', kerb1:'#ff0000', kerb2:'#ffffff', cpColor:'#ff7700', accentColor:'#ff7700', barrierColor:'#404044', grandstandColor:'#201520', treeColor:'#083008', sceneryTint:'#ff7700', pitColor:'#181015',
    ctrl:[[.50,.10],[.58,.095],[.66,.09],[.74,.09],[.82,.095],[.88,.10],[.92,.115],[.94,.14],[.94,.20],[.92,.26],[.88,.31],[.84,.34],[.78,.36],[.72,.36],[.66,.34],[.62,.30],[.60,.25],[.62,.19],[.66,.14],[.70,.12],[.74,.11],[.78,.12],[.82,.14],[.86,.17],[.88,.22],[.86,.28],[.82,.33],[.76,.37],[.68,.40],[.60,.42],[.52,.43],[.44,.41],[.37,.38],[.32,.33],[.28,.27],[.27,.20],[.28,.14],[.31,.10],[.36,.08],[.42,.085],[.48,.09],[.50,.10]]},
  {name:'INTERLAGOS', bg:'#04080a', nebula:'#081218', road:'#1c2020', roadEdge:'#2e3232', runoff:'#0e1414', grass:'#061008', kerb1:'#008000', kerb2:'#ffff00', cpColor:'#00d4ff', accentColor:'#00d4ff', barrierColor:'#404850', grandstandColor:'#102020', treeColor:'#0c3410', sceneryTint:'#00d4ff', pitColor:'#141c1c',
    ctrl:[[.50,.10],[.57,.095],[.64,.09],[.70,.09],[.76,.093],[.82,.10],[.87,.11],[.91,.14],[.93,.18],[.93,.24],[.91,.30],[.87,.35],[.82,.38],[.76,.40],[.70,.40],[.64,.38],[.58,.35],[.54,.30],[.52,.24],[.54,.18],[.58,.13],[.63,.10],[.56,.35],[.52,.40],[.50,.46],[.50,.52],[.52,.58],[.56,.63],[.61,.67],[.66,.70],[.70,.71],[.74,.70],[.78,.67],[.80,.63],[.80,.57],[.78,.51],[.74,.46],[.68,.41],[.60,.38],[.55,.40],[.50,.44],[.46,.50],[.44,.57],[.44,.64],[.46,.70],[.50,.74],[.55,.77],[.60,.79],[.54,.75],[.48,.72],[.42,.68],[.37,.63],[.33,.57],[.30,.50],[.29,.43],[.30,.36],[.32,.29],[.35,.22],[.39,.16],[.44,.11],[.50,.10]]}
];

// ========== GAME ENGINE (from V12, merged with V4 remote logic) ==========
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d',{alpha:false});
const WORLD_W = 5800, WORLD_H = 4200;
let camX=0, camY=0;
const CAM_ZOOM = 1.08, CAM_LERP = 0.07;
let gameOn = false, raceTime = 0, lastTs = 0, raf = null;
let spline = [], trackW = 148;
let players = [], myP = null;
let cpIndices = [];
let usedQ = new Set();
let qActive = false, curQ = null, qAns = false;
let qTimerSec = 10, qInterval = null;
let ended = false;
let scenery = [], roadMarkers = [];
const isMobile = /Android|iPhone|iPad|iPod|Touch/i.test(navigator.userAgent) || ('ontouchstart' in window);
let bgCache = null, bgCacheW = 0, bgCacheH = 0, bgCacheTrack = -1;

// ========== QUESTIONS (from V12) ==========
const QDB = [
  {q:"A satellite moves around a‚Ä¶",opts:["Star","Larger object"],ans:1},
  {q:"Sputnik-1 was launched in‚Ä¶",opts:["1957","1965"],ans:0},
  {q:"The Moon is a‚Ä¶",opts:["Natural satellite","Artificial satellite"],ans:0},
  {q:"Satellite communication uses‚Ä¶",opts:["Optical fibers only","Microwaves"],ans:1},
  {q:"A satellite stays in orbit due to‚Ä¶",opts:["Gravity","Wind"],ans:0},
  {q:"GEO satellites appear‚Ä¶",opts:["Stationary","Very fast moving"],ans:0},
  {q:"LEO satellites orbit below‚Ä¶",opts:["2000 km","20,000 km"],ans:0},
  {q:"An artificial satellite is‚Ä¶",opts:["Man-made","Naturally formed"],ans:0},
  {q:"Apogee is the point‚Ä¶",opts:["Closest to Earth","Farthest from Earth"],ans:1},
  {q:"Perigee is‚Ä¶",opts:["Closest to Earth","Farthest from Earth"],ans:0},
  {q:"GEO altitude is about‚Ä¶",opts:["35,786 km","3,578 km"],ans:0},
  {q:"Kepler's first law states orbit is‚Ä¶",opts:["Square","Elliptical"],ans:1},
  {q:"Kepler's second law deals with‚Ä¶",opts:["Equal areas in equal time","Equal speed always"],ans:0},
  {q:"Kepler's third law relates‚Ä¶",opts:["Period and semi-major axis","Mass and speed only"],ans:0},
  {q:"Satellite speed is higher at‚Ä¶",opts:["Apogee","Perigee"],ans:1},
  {q:"Newton's first law is also called‚Ä¶",opts:["Law of inertia","Law of gravity"],ans:0},
  {q:"Force equals mass √ó‚Ä¶",opts:["Speed","Acceleration"],ans:1},
  {q:"Every action has‚Ä¶",opts:["No reaction","Equal opposite reaction"],ans:1},
  {q:"Power subsystem mainly uses‚Ä¶",opts:["Solar cells","Diesel"],ans:0},
  {q:"TT&C stands for‚Ä¶",opts:["Tracking, Telemetry & Command","Timing, Testing & Control"],ans:0},
  {q:"A transponder‚Ä¶",opts:["Amplifies and retransmits signal","Stores food"],ans:0},
  {q:"LNA stands for‚Ä¶",opts:["Low Noise Amplifier","Long Network Antenna"],ans:0},
  {q:"C-band downlink is around‚Ä¶",opts:["4 GHz","40 GHz"],ans:0},
  {q:"Ku-band uplink is around‚Ä¶",opts:["14 GHz","1.4 GHz"],ans:0},
  {q:"DBS stands for‚Ä¶",opts:["Direct Broadcast Satellite","Double Beam System"],ans:0},
  {q:"Eclipse occurs near‚Ä¶",opts:["Equinox","Solstice only"],ans:0},
  {q:"Look angles include‚Ä¶",opts:["Speed & mass","Azimuth & elevation"],ans:1},
  {q:"Average Earth radius used is‚Ä¶",opts:["6371 km","1000 km"],ans:0},
  {q:"F1 DRS stands for‚Ä¶",opts:["Drag Reduction System","Dynamic Racing Speed"],ans:0},
  {q:"Which F1 team uses Prancing Horse logo?",opts:["McLaren","Ferrari"],ans:1},
  {q:"The Monaco GP circuit length is‚Ä¶",opts:["3.337 km","5.891 km"],ans:0},
  {q:"F1 qualifying uses how many segments?",opts:["2 (Q1,Q2)","3 (Q1,Q2,Q3)"],ans:1},
  {q:"Fastest lap bonus point awarded since‚Ä¶",opts:["2019","2021"],ans:0},
  {q:"Silverstone is in‚Ä¶",opts:["England","Germany"],ans:0},
  {q:"Pirelli is the official F1 tyre supplier since‚Ä¶",opts:["2011","2015"],ans:0},
  {q:"Red Bull's main colour is‚Ä¶",opts:["Blue","Red"],ans:0},
  {q:"KERS stands for‚Ä¶",opts:["Kinetic Energy Recovery System","Kinetic Engine Rev Sensor"],ans:0},
  {q:"ERS in modern F1 means‚Ä¶",opts:["Energy Recovery System","Engine Response Speed"],ans:0},
  {q:"Telemetry sends data‚Ä¶",opts:["From Earth to satellite","From satellite to Earth"],ans:1},
  {q:"Reaction wheels are used for‚Ä¶",opts:["Attitude control","Cooking"],ans:0},
  {q:"Eccentricity 0 means orbit is‚Ä¶",opts:["Circular","Parabolic"],ans:0},
  {q:"Sun transit outage happens when‚Ä¶",opts:["Sun behind satellite","Moon behind satellite"],ans:0},
  {q:"MEO lies between‚Ä¶",opts:["LEO and GEO","GEO and Moon"],ans:0},
  {q:"A polar orbit has inclination near‚Ä¶",opts:["0¬∞","90¬∞"],ans:1},
  {q:"Roll axis moves satellite footprint‚Ä¶",opts:["East-West","North-South"],ans:1},
  {q:"LNB stands for‚Ä¶",opts:["Low Noise Block","Large Network Box"],ans:0},
  {q:"Station keeping keeps satellite in‚Ä¶",opts:["Correct orbit","Storage room"],ans:0},
  {q:"Which company makes F1 engines for Red Bull?",opts:["Honda/RBPTH","Mercedes"],ans:0},
  {q:"Spa-Francorchamps is in‚Ä¶",opts:["Belgium","France"],ans:0},
  {q:"McLaren's signature colour is‚Ä¶",opts:["Papaya Orange","Dark Green"],ans:0},
];

function cr(p0,p1,p2,p3,t){
  const t2=t*t,t3=t2*t;
  return{x:.5*((2*p1.x)+(-p0.x+p2.x)*t+(2*p0.x-5*p1.x+4*p2.x-p3.x)*t2+(-p0.x+3*p1.x-3*p2.x+p3.x)*t3),y:.5*((2*p1.y)+(-p0.y+p2.y)*t+(2*p0.y-5*p1.y+4*p2.y-p3.y)*t2+(-p0.y+3*p1.y-3*p2.y+p3.y)*t3)};
}
function buildSpline(ctrl,W,H,res=3000){
  const pts=ctrl.map(([x,y])=>({x:x*W,y:y*H}));
  const n=pts.length-1;const out=[];
  for(let i=0;i<n;i++){const p0=pts[Math.max(0,i-1)],p1=pts[i],p2=pts[i+1],p3=pts[Math.min(n,i+2)];const seg=Math.ceil(res/n);for(let j=0;j<seg;j++)out.push(cr(p0,p1,p2,p3,j/seg));}
  out.push({...out[0]});return out;
}
function splineAt(t){const n=spline.length;return spline[((Math.floor(t*n)%n)+n)%n];}
function splineAngle(t){const n=spline.length;const i=((Math.floor(t*n)%n)+n)%n;const j=(i+1)%n;return Math.atan2(spline[j].y-spline[i].y,spline[j].x-spline[i].x);}

function makeP(pd, idx){
  const car = F1_CARS.find(c=>c.id===pd.carId) || F1_CARS[idx%F1_CARS.length];
  return {
    id:pd.id, name:pd.name, color:pd.color, emoji:pd.emoji, car,
    cpu:pd.cpu || false,
    t:.004 * idx, speed:0,
    baseSpd:.000200 + idx*.000010, maxSpd:.000560,
    lat: idx%2===0 ? .28 : -.28,
    boost:false, boostMs:0, boostDur:5000,
    checkpt:pd.checkpt || 0, cpDone:[], score:pd.score||0, boosts:pd.boosts||0,
    fin:pd.fin||false, finTime:pd.ftime||0, finDetected:false,
    L:false,R:false,A:false,B:false,
    cpuWait:0, atCp:false,
    flame:0, x:0, y:0, ang:0,
    trail:[], prevT:-1,
    // remote interpolation
    _tgtX:null, _tgtY:null, _tgtAng:null, _remoteT:null,
  };
}

function buildCheckpoints(){
  const n=spline.length; cpIndices = [];
  for(let i=1;i<=5;i++) cpIndices.push(Math.floor(i*n/6));
}

function buildRoadMarkers(){
  roadMarkers=[]; const n=spline.length; const step=Math.floor(n/180);
  for(let i=0;i<n;i+=step){const pos=spline[i]; const ang=splineAngle(i/n); roadMarkers.push({x:pos.x,y:pos.y,ang,i});}
}

function buildScenery(def){
  scenery=[]; const n=spline.length;
  const seed=Math.floor(Math.random()*1000);
  const rng=s=>((Math.sin(s*127.1+seed)*43758.5453)%1+1)%1;
  const step=Math.floor(n/90);
  for(let i=0;i<n;i+=step){
    const pos=spline[i]; const ang=splineAngle(i/n); const perp=ang+Math.PI/2;
    const ri=rng(i); const side=(rng(i+1)<.5?1:-1);
    if(ri<.20){
      const dist=trackW*1.12+rng(i+2)*25; const w=100+rng(i+3)*80, rows=3+Math.floor(rng(i+4)*4);
      scenery.push({type:'grandstand',x:pos.x+Math.cos(perp)*dist*side,y:pos.y+Math.sin(perp)*dist*side,ang:perp,w,rows,side,seed:i,color:def.grandstandColor});
    }else if(ri<.45){
      const dist=trackW*1.15+rng(i+5)*40;
      scenery.push({type:'trees',x:pos.x+Math.cos(perp)*dist*side,y:pos.y+Math.sin(perp)*dist*side,count:5+Math.floor(rng(i+6)*7),color:def.treeColor,seed:i});
    }else if(ri<.58){
      const dist=trackW*.70+8;
      scenery.push({type:'tires',x:pos.x+Math.cos(perp)*dist*side,y:pos.y+Math.sin(perp)*dist*side,ang:perp,len:40+rng(i+7)*60});
    }else if(ri<.72){
      const dist=trackW*.95+rng(i+8)*18;
      const sponsors=['PETRONAS','DHL','ROLEX','AWS','PIRELLI','ARAMCO','HEINEKEN','SAT BUKKY','BRIDGESTONE','LENOVO'];
      scenery.push({type:'adboard',x:pos.x+Math.cos(perp)*dist*side,y:pos.y+Math.sin(perp)*dist*side,ang:perp,text:sponsors[Math.floor(rng(i+9)*sponsors.length)],color:def.sceneryTint});
    }else if(ri<.86){
      const dist=trackW*1.35+rng(i+10)*60;
      scenery.push({type:'building',x:pos.x+Math.cos(perp)*dist*side,y:pos.y+Math.sin(perp)*dist*side,ang:perp,w:50+rng(i+11)*90,h:60+rng(i+12)*120,seed:i,color:def.grandstandColor});
    }else{
      const dist=trackW*.88;
      scenery.push({type:'marshal',x:pos.x+Math.cos(perp)*dist*side,y:pos.y+Math.sin(perp)*dist*side,ang:perp,side});
    }
  }
  for(let i=0;i<12;i++){
    const t2=i*.008; const pos2=splineAt(t2); const ang2=splineAngle(t2); const perp2=ang2+Math.PI/2;
    const lane=(i%2===0?1:-1)*(trackW*.28);
    scenery.push({type:'grid',x:pos2.x+Math.cos(perp2)*lane,y:pos2.y+Math.sin(perp2)*lane,ang:ang2,num:i+1});
  }
}

function beginGame(){
  // Reset finish flags for all players
  if(room && room.players) {
    Object.values(room.players).forEach(p => {
      p.fin = false;
      p.ftime = 0;
    });
  }
  
  gameOn=false; ended=false; usedQ.clear();
  canvas.width = innerWidth; canvas.height = innerHeight; trackW = 148;
  const def = TRACK_DEFS[room.track || 0];
  spline = buildSpline(def.ctrl, WORLD_W, WORLD_H, 3000);
  buildCheckpoints(); buildScenery(def); buildRoadMarkers();
  if(spline.length){camX=spline[0].x-innerWidth/(2*CAM_ZOOM); camY=spline[0].y-innerHeight/(2*CAM_ZOOM);}
  
  const plist = Object.values(room.players || {}).map((pd,i) => makeP(pd,i));
  players = plist;
  myP = players.find(p => p.id === myId);

  document.querySelectorAll('.screen').forEach(s=>s.classList.add('gone'));
  canvas.style.display='block';
  document.getElementById('hud').style.display='block';
  document.getElementById('boost-hud').style.display='none';
  document.getElementById('qOverlay').style.display='none';
  if(pingEl) pingEl.style.opacity='1';

  // Keyboard
  document.onkeydown = e => {
    if(!myP) return;
    if(e.key==='ArrowLeft'||e.key==='a'||e.key==='A') myP.L = true;
    if(e.key==='ArrowRight'||e.key==='d'||e.key==='D') myP.R = true;
    if(e.key==='ArrowUp'||e.key==='w'||e.key==='W') myP.A = true;
    if(e.key==='ArrowDown'||e.key==='s'||e.key==='S') myP.B = true;
  };
  document.onkeyup = e => {
    if(!myP) return;
    if(e.key==='ArrowLeft'||e.key==='a'||e.key==='A') myP.L = false;
    if(e.key==='ArrowRight'||e.key==='d'||e.key==='D') myP.R = false;
    if(e.key==='ArrowUp'||e.key==='w'||e.key==='W') myP.A = false;
    if(e.key==='ArrowDown'||e.key==='s'||e.key==='S') myP.B = false;
  };

  const tcEl = document.getElementById('touch-controls');
  tcEl.style.display='flex';
  document.getElementById('gear-hud').style.display='block';

  function bindBtn(id, key){
    const el=document.getElementById(id); if(!el) return;
    function press(e){e.preventDefault(); e.stopPropagation(); if(myP) myP[key]=true; el.classList.add('pressed');}
    function release(e){e.preventDefault(); e.stopPropagation(); if(myP) myP[key]=false; el.classList.remove('pressed');}
    el.addEventListener('touchstart', press, {passive:false});
    el.addEventListener('touchend', release, {passive:false});
    el.addEventListener('touchcancel', release, {passive:false});
    el.addEventListener('mousedown', press);
    el.addEventListener('mouseup', release);
    el.addEventListener('mouseleave', release);
  }
  bindBtn('tc-gas','A'); bindBtn('tc-brake','B');

  if(isMobile){const ch=document.getElementById('ctrl-hint'); if(ch)ch.style.display='none';}

  if(room.code !== 'SOLO'){
    listenPositions(room.code);
    startPosPush(room.code);
    startPing();
  }

  countdown(() => {
    gameOn = true; raceTime = 0; lastTs = performance.now();
    if(raf) cancelAnimationFrame(raf);
    raf = requestAnimationFrame(loop);
  });
}

function countdown(cb){
  const ov = document.getElementById('cdOverlay'); const num = document.getElementById('cd-num');
  ov.style.display = 'flex'; let n = 3;
  const step = () => {
    num.textContent = n>0 ? n : 'GO!';
    num.style.color = n>0 ? 'var(--green)' : 'var(--yellow)';
    num.style.animation = 'none'; void num.offsetWidth; num.style.animation = 'cdPop .85s ease-out forwards';
    playCountdownBeep(n);
    if(n===0) setTimeout(()=>{ov.style.display='none'; cb();}, 700);
    else{ n--; setTimeout(step, 900); }
  };
  step();
}

function updateCamera(dtScale){
  if(!myP) return;
  const tx = myP.x - canvas.width/(2*CAM_ZOOM); const ty = myP.y - canvas.height/(2*CAM_ZOOM);
  const lf = 1 - Math.pow(1-CAM_LERP, dtScale);
  camX += (tx-camX)*lf; camY += (ty-camY)*lf;
}

const FIXED_DT = 16.667;
function loop(ts){
  const rawDt = ts - lastTs; const dt = Math.min(Math.max(rawDt,1),20); lastTs = ts;
  const dtScale = dt/FIXED_DT;
  if(gameOn) raceTime += dt;
  updateCamera(dtScale); update(dt, dtScale); render(); renderMinimap(); updateHUD();
  if(gameOn || !ended) raf = requestAnimationFrame(loop);
}

function update(dt, dtScale){
  if(!gameOn) return;
  const accel = 0.000022*dtScale; const decel = 0.000032*dtScale; const steer = 0.0028*dtScale;

  players.forEach(p => {
    if(p.fin) return;
    if(p.atCp && !p.cpu) return;

    // ===== REMOTE PLAYER (from V4 interpolation) =====
    if(p.id !== myId && !p.cpu && p._tgtX != null){
      const lerpF = 0.22;
      p.x += (p._tgtX - p.x) * lerpF;
      p.y += (p._tgtY - p.y) * lerpF;
      let da = (p._tgtAng - p.ang);
      if(da > Math.PI) da -= Math.PI*2; if(da < -Math.PI) da += Math.PI*2;
      p.ang += da * lerpF;
      p.t = p._remoteT || p.t;
      p.flame = p.boost ? .7+.3*Math.random() : 0;
      if(p._tt % 2 === 0){
        p.trail.push({x:p.x,y:p.y,a:.55});
        if(p.trail.length > (isMobile?12:22)) p.trail.shift();
      }
      p._tt = (p._tt||0) + 1;
      const ff = Math.pow(.86, dtScale); p.trail.forEach(t=>t.a*=ff);
      return;
    }

    // ===== LOCAL OR CPU PLAYER =====
    if(p.boost){ p.boostMs -= dt; if(p.boostMs<=0){p.boost=false; p.flame=0;} else p.flame=.7+.3*Math.random(); }
    const bm = p.boost ? 2.0 : 1;
    p.car._flame = p.flame;

    if(p.cpu){
      const targetLat = Math.sin(p.t*Math.PI*10 + p.id.charCodeAt(0))*.3;
      p.lat += (targetLat - p.lat)*0.04*dtScale;
      if(p.atCp){
        p.speed *= Math.max(0, 1-0.12*dtScale); p.cpuWait -= dt;
        if(p.cpuWait<=0){ if(Math.random()<.65){p.boost=true; p.boostMs=p.boostDur; p.boosts++; p.score++;} p.atCp=false; }
      }else{ const tgtSpd = p.baseSpd*bm*(0.88+.14*Math.sin(p.t*77)); p.speed += (tgtSpd-p.speed)*0.05*dtScale; }
    }else{
      if(p.A) p.speed = Math.min(p.speed+accel, p.maxSpd*bm);
      else if(p.B) p.speed = Math.max(p.speed-decel, 0);
      else if(p.boost) p.speed = Math.min(p.speed+accel*.5, p.maxSpd*bm);
      else{ const coast = p.baseSpd*.5; p.speed += (coast-p.speed)*0.02*dtScale; }
      p.speed = Math.max(0, Math.min(p.speed, p.maxSpd*bm));
      if(p.L) p.lat = Math.max(p.lat-steer, -.95);
      if(p.R) p.lat = Math.min(p.lat+steer, .95);
      p.lat *= Math.pow(.993, dtScale);
    }

    p.prevT = p.t;
    p.t = (p.t + p.speed*dtScale) % 1; if(p.t<0) p.t += 1;
    const base = splineAt(p.t); const ang = splineAngle(p.t); const perp = ang + Math.PI/2;
    p.x = base.x + Math.cos(perp) * p.lat * trackW * .44;
    p.y = base.y + Math.sin(perp) * p.lat * trackW * .44;
    p.ang = ang;

    if(!p._tt) p._tt = 0; p._tt++;
    if(p._tt % (isMobile?2:1) === 0){
      p.trail.push({x:p.x, y:p.y, a:.55});
      if(p.trail.length > (isMobile?12:22)) p.trail.shift();
    }
    const ff = Math.pow(.86, dtScale); p.trail.forEach(t => t.a *= ff);

    // Checkpoint
    if(!p.atCp && p.checkpt < 5){
      const n = spline.length, pidx = Math.floor(p.t * n); const target = cpIndices[p.checkpt];
      const d = Math.min(Math.abs(pidx-target), n-Math.abs(pidx-target));
      if(d < 18 && !p.cpDone.includes(p.checkpt)){
        p.cpDone.push(p.checkpt); p.checkpt++;
        if(p.cpu){ p.atCp = true; p.cpuWait = 900 + Math.random()*1400; }
        else triggerQ(p, p.checkpt-1);
      }
    }
    // Finish - only mark player as finished, do not end race
    if(p.checkpt >= 5 && !p.fin && !p.finDetected){
      const n = spline.length, pidx = Math.floor(p.t * n);
      if((pidx < 20 || (n-pidx) < 20) && p.prevT > 0.90){
        p.fin = true;
        p.finTime = raceTime;
        p.finDetected = true;
        
        // Update Firebase with finish status and final stats
        if(p.id === myId && room && room.code !== 'SOLO'){
          db.ref('rooms/' + room.code + '/players/' + myId).update({
            fin: true, 
            ftime: p.finTime, 
            score: p.score, 
            boosts: p.boosts, 
            checkpt: p.checkpt
          });
        }
        
        // Play finish sound for the player
        if(p.id === myId) {
          playBeep(880, .3, .5, 'sine');
          setTimeout(() => playBeep(1320, .5, .6, 'sine'), 200);
          
          // Show local notification
          const fb = document.getElementById('q-fb');
          if(fb) {
            fb.textContent = 'üèÅ YOU FINISHED! WAITING FOR OTHERS...';
            fb.className = 'q-feedback ok';
            fb.style.display = 'block';
            setTimeout(() => { fb.style.display = 'none'; }, 3000);
          }
        }
      }
    }
  });

  // Gear display
  if(myP){
    const r = myP.speed / myP.maxSpd;
    const g = r<.12?1: r<.28?2: r<.44?3: r<.60?4: r<.76?5: r<.90?6:7;
    const gEl = document.getElementById('gear-hud'); if(gEl) gEl.textContent = myP.boost ? '‚ö°' : g;
  }
  
  // Check if all players have finished
  if(gameOn && !ended) {
    checkEnd();
  }
}

function checkEnd(){
  // Check if all players have finished
  const allDone = players.every(p => p.fin);
  
  if(!ended && allDone){
    // All players finished, end the race after a short delay
    setTimeout(() => {
      if(!ended) doEndRace();
    }, 1500);
  }
}

function doEndRace(){
  ended=true; gameOn=false; stopEngineSound(); clearQuestion();
  stopPosPush(); stopPing();
  
  // Final update to Firebase with all players' final stats
  if(room && room.code !== 'SOLO' && roomRef){
    // Update each player's final stats in the room
    const updates = {};
    players.forEach(p => {
      if(p.id !== 'solo' && !p.cpu) {
        updates[`players/${p.id}/fin`] = p.fin;
        updates[`players/${p.id}/ftime`] = p.finTime;
        updates[`players/${p.id}/score`] = p.score;
        updates[`players/${p.id}/boosts`] = p.boosts;
      }
    });
    
    // Update room state
    updates['state'] = 'done';
    roomRef.update(updates);
  }
  
  showResults();
}

function triggerQ(p, cpIdx){
  if(qActive) return; p.atCp = true; qActive = true; qAns = false;
  const pool = []; for(let i=0;i<QDB.length;i++) if(!usedQ.has(i)) pool.push(i);
  if(!pool.length){ usedQ.clear(); for(let i=0;i<QDB.length;i++) pool.push(i); }
  const qi = pool[Math.floor(Math.random()*pool.length)]; usedQ.add(qi); curQ = {...QDB[qi], qi};
  document.getElementById('q-cp').textContent = `CHECKPOINT ${cpIdx+1} / 5`;
  document.getElementById('q-text').textContent = curQ.q;
  document.getElementById('q-ta').textContent = curQ.opts[0]; document.getElementById('q-tb').textContent = curQ.opts[1];
  document.getElementById('q-a').className = 'q-opt'; document.getElementById('q-b').className = 'q-opt';
  document.getElementById('q-a').disabled = false; document.getElementById('q-b').disabled = false;
  document.getElementById('q-fb').textContent = ''; document.getElementById('q-fb').className = 'q-feedback';
  document.getElementById('qOverlay').style.display = 'flex';
  qTimerSec = 10; const td = document.getElementById('q-timer'); td.textContent = 10; td.className = 'q-timer';
  clearInterval(qInterval);
  qInterval = setInterval(() => { qTimerSec--; td.textContent = qTimerSec; if(qTimerSec<=3) td.className = 'q-timer red'; if(qTimerSec<=0){ clearInterval(qInterval); answer(-1); } }, 1000);
}

function answer(chosen){
  if(qAns) return; qAns = true; clearInterval(qInterval);
  const correct = curQ.ans; const ok = chosen === correct;
  document.getElementById('q-a').disabled = true; document.getElementById('q-b').disabled = true;
  if(chosen===0) document.getElementById('q-a').classList.add(ok?'correct':'wrong');
  if(chosen===1) document.getElementById('q-b').classList.add(ok?'correct':'wrong');
  if(chosen!==correct) document.getElementById(correct===0?'q-a':'q-b').classList.add('correct');
  const fb = document.getElementById('q-fb');
  if(ok){
    fb.textContent = '‚ö° CORRECT! 5s BOOST ‚Äî 2√ó SPEED!'; fb.className = 'q-feedback ok';
    if(myP){ myP.score++; myP.boosts++; myP.boost = true; myP.boostMs = myP.boostDur; myP.speed = myP.maxSpd * 2; }
  } else {
    const wasBosting = myP && myP.boost && myP.boostMs > 0;
    fb.textContent = chosen===-1 ? (wasBosting?'‚è± TIME\'S UP! ‚Äî BOOST CANCELLED!':'‚è± TIME\'S UP!') : (wasBosting?'‚úó WRONG ‚Äî BOOST CANCELLED!':'‚úó WRONG ‚Äî BACK TO RACING');
    fb.className = 'q-feedback miss';
    if(myP){ myP.boost = false; myP.boostMs = 0; myP.flame = 0; myP.speed = Math.min(myP.speed, myP.maxSpd); }
  }
  playCheckpointSound(ok);
  setTimeout(() => { clearQuestion(); if(myP) myP.atCp = false; }, ok?700:500);
}

function clearQuestion(){ qActive = false; curQ = null; clearInterval(qInterval); document.getElementById('qOverlay').style.display = 'none'; }

function render(){
  const W = canvas.width, H = canvas.height; const def = TRACK_DEFS[room.track||0]; const trackIdx = room.track||0;
  if(!bgCache || bgCacheW!==W || bgCacheH!==H || bgCacheTrack!==trackIdx) buildBgCache(def,W,H,trackIdx);
  ctx.drawImage(bgCache,0,0);
  ctx.save(); ctx.scale(CAM_ZOOM,CAM_ZOOM); ctx.translate(-camX,-camY);
  renderSceneryBack(def); renderTrack(def); renderCPs(def); renderFinish(def); renderSceneryFront(def);
  players.slice().sort((a,b)=>(a.fin?1:0)-(b.fin?1:0)).forEach(p=>renderPlayer(p,def));
  ctx.restore();

  if(myP){
    const sr = myP.speed / (myP.maxSpd * (myP.boost?2:1));
    if(sr > .4){
      const i = (sr-.4)/.6;
      const vg = ctx.createRadialGradient(W/2,H/2,H*.15,W/2,H/2,H*.85);
      vg.addColorStop(0,'transparent'); vg.addColorStop(.55,'transparent');
      vg.addColorStop(1,`rgba(0,0,0,${.65*i})`);
      ctx.fillStyle = vg; ctx.fillRect(0,0,W,H);
    }
  }

  if(myP && myP.boost){
    const boostRatio = myP.boostMs / myP.boostDur;
    if(boostRatio > .92){
      const fl = ((boostRatio-.92)/.08);
      ctx.fillStyle = `rgba(255,180,30,${0.22*fl})`; ctx.fillRect(0,0,W,H);
    }
    const bg2 = ctx.createRadialGradient(W/2,H/2,H*.3,W/2,H/2,H*.9);
    bg2.addColorStop(0,'transparent'); bg2.addColorStop(.7,'transparent');
    bg2.addColorStop(1,`rgba(255,120,0,${0.08*boostRatio})`);
    ctx.fillStyle = bg2; ctx.fillRect(0,0,W,H);
  }
}

function buildBgCache(def,W,H,trackIdx){
  const oc = document.createElement('canvas'); oc.width = W; oc.height = H;
  const ox = oc.getContext('2d');
  const sky = ox.createLinearGradient(0,0,W*.3,H);
  sky.addColorStop(0,def.bg); sky.addColorStop(.4,def.nebula+'88'); sky.addColorStop(.8,def.bg+'dd'); sky.addColorStop(1,def.bg);
  ox.fillStyle = sky; ox.fillRect(0,0,W,H);
  const haze = ox.createLinearGradient(0,H*.35,0,H*.65);
  haze.addColorStop(0,'transparent'); haze.addColorStop(.5,def.nebula+'28'); haze.addColorStop(1,'transparent');
  ox.fillStyle = haze; ox.fillRect(0,0,W,H);
  const nb = ox.createRadialGradient(W*.38,H*.28,0,W*.38,H*.28,W*.7);
  nb.addColorStop(0,def.nebula+'66'); nb.addColorStop(.45,def.nebula+'28'); nb.addColorStop(1,'transparent');
  ox.fillStyle = nb; ox.fillRect(0,0,W,H);
  const nb2 = ox.createRadialGradient(W*.72,H*.75,0,W*.72,H*.75,W*.5);
  nb2.addColorStop(0,def.nebula+'33'); nb2.addColorStop(1,'transparent');
  ox.fillStyle = nb2; ox.fillRect(0,0,W,H);
  ox.globalAlpha = .025;
  for(let i=0;i<2000;i++){ const x=Math.random()*W, y=Math.random()*H, r=Math.random()*1.5; ox.fillStyle = Math.random()>.5?'#ffffff':'#000000'; ox.beginPath(); ox.arc(x,y,r,0,Math.PI*2); ox.fill(); }
  ox.globalAlpha = 1;
  bgCache = oc; bgCacheW = W; bgCacheH = H; bgCacheTrack = trackIdx;
}

function renderTrack(def){
  if(spline.length<2) return;
  const buildPath = () => { ctx.beginPath(); spline.forEach((p,i)=>i===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y)); ctx.closePath(); };
  ctx.lineCap = 'round'; ctx.lineJoin = 'round';
  ctx.strokeStyle = def.grass; ctx.lineWidth = trackW+290; buildPath(); ctx.stroke();
  ctx.save(); ctx.globalAlpha=.12; ctx.strokeStyle = darkenHex(def.grass,15)+'cc'; ctx.lineWidth = trackW+340; ctx.setLineDash([40,60]); buildPath(); ctx.stroke(); ctx.setLineDash([]); ctx.restore();
  ctx.strokeStyle = def.runoff; ctx.lineWidth = trackW+170; buildPath(); ctx.stroke();
  ctx.save(); ctx.globalAlpha=.18; ctx.strokeStyle = 'rgba(255,255,255,.15)'; ctx.lineWidth = trackW+170; ctx.setLineDash([20,40]); ctx.lineDashOffset = (raceTime*.03)%60; buildPath(); ctx.stroke(); ctx.setLineDash([]); ctx.restore();
  ctx.strokeStyle = 'rgba(0,0,0,.5)'; ctx.lineWidth = trackW+72; buildPath(); ctx.stroke();
  ctx.strokeStyle = def.barrierColor; ctx.lineWidth = trackW+62; buildPath(); ctx.stroke();
  ctx.save(); ctx.globalAlpha=.35; ctx.strokeStyle = 'rgba(255,255,255,.5)'; ctx.lineWidth = trackW+62; ctx.setLineDash([8,24]); ctx.lineDashOffset = -(raceTime*.04)%32; buildPath(); ctx.stroke(); ctx.setLineDash([]); ctx.restore();
  ctx.strokeStyle = def.kerb1+'f8'; ctx.lineWidth = trackW+28; buildPath(); ctx.stroke();
  ctx.save(); ctx.strokeStyle = def.kerb2+'f0'; ctx.lineWidth = trackW+28; ctx.setLineDash([20,20]); buildPath(); ctx.stroke(); ctx.setLineDash([]); ctx.restore();
  ctx.strokeStyle = 'rgba(0,0,0,.35)'; ctx.lineWidth = trackW+4; buildPath(); ctx.stroke();
  ctx.strokeStyle = def.road; ctx.lineWidth = trackW; buildPath(); ctx.stroke();
  ctx.save(); ctx.globalAlpha=.22;
  const roadHL = ctx.createLinearGradient(0,0,trackW*.5,WORLD_H);
  roadHL.addColorStop(0,lightenHex(def.road,18)); roadHL.addColorStop(.5,def.road); roadHL.addColorStop(1,darkenHex(def.road,10));
  ctx.strokeStyle = roadHL; ctx.lineWidth = trackW*.6; buildPath(); ctx.stroke(); ctx.restore();
  ctx.save(); ctx.globalAlpha=.12; ctx.strokeStyle = 'rgba(80,80,80,.6)'; ctx.lineWidth = trackW*.35; buildPath(); ctx.stroke(); ctx.restore();
  ctx.save(); ctx.globalAlpha=.08; ctx.strokeStyle = '#111'; ctx.lineWidth = trackW*.22; ctx.setLineDash([15,45]); buildPath(); ctx.stroke(); ctx.setLineDash([]); ctx.restore();
  ctx.save(); ctx.strokeStyle = 'rgba(255,255,255,.14)'; ctx.lineWidth = 2.5; ctx.setLineDash([32,44]); ctx.lineDashOffset = -(raceTime*.09)%76; buildPath(); ctx.stroke(); ctx.setLineDash([]); ctx.restore();
  ctx.save(); ctx.strokeStyle = def.accentColor+'55'; ctx.lineWidth = 6; ctx.setLineDash([14,14]); ctx.lineDashOffset = -(raceTime*.06)%28;
  ctx.beginPath(); for(let i=0;i<Math.floor(spline.length*.12);i++){ const p=spline[i]; if(i===0)ctx.moveTo(p.x,p.y); else ctx.lineTo(p.x,p.y); } ctx.stroke();
  ctx.setLineDash([]); ctx.restore();
}

function renderSceneryBack(def){
  const vx0=camX-200, vy0=camY-200, vx1=camX+canvas.width/CAM_ZOOM+200, vy1=camY+canvas.height/CAM_ZOOM+200;
  const vis = s => s.x>=vx0 && s.x<=vx1 && s.y>=vy0 && s.y<=vy1;
  scenery.forEach(s => {
    if(!vis(s)) return;
    if(s.type==='trees'){
      ctx.save();
      for(let i=0;i<s.count;i++){
        const ox = (i-(s.count-1)/2)*20; const oy = Math.sin(s.seed+i)*12;
        const tx = s.x+ox, ty = s.y+oy; const r = Math.max(1,12+Math.sin(s.seed*3+i)*4);
        ctx.globalAlpha=0.55; ctx.fillStyle='#2a1a0e'; ctx.fillRect(tx-2.5,ty+r*.4,5,r*.7);
        ctx.globalAlpha=0.4;
        const shadeTr = ctx.createRadialGradient(tx,ty+r*.3,0,tx,ty,r*1.1);
        shadeTr.addColorStop(0,'rgba(0,0,0,.5)'); shadeTr.addColorStop(1,'transparent');
        ctx.fillStyle=shadeTr; ctx.beginPath(); ctx.arc(tx,ty,r*1.1,0,Math.PI*2); ctx.fill();
        ctx.globalAlpha=0.9;
        const tgr = ctx.createRadialGradient(tx-r*.3,ty-r*.3,0,tx,ty,r);
        tgr.addColorStop(0,lightenHex(def.treeColor,20)+'ff');
        tgr.addColorStop(.55,def.treeColor+'ee');
        tgr.addColorStop(1,darkenHex(def.treeColor,20)+'66');
        ctx.fillStyle = tgr; ctx.beginPath(); ctx.arc(tx,ty,r,0,Math.PI*2); ctx.fill();
        ctx.globalAlpha=0.2; ctx.fillStyle='rgba(255,255,255,.6)';
        ctx.beginPath(); ctx.arc(tx-r*.28,ty-r*.3,Math.max(0.1,r*.25),0,Math.PI*2); ctx.fill();
      }
      ctx.globalAlpha=1; ctx.restore();
    } else if(s.type==='grandstand'){
      ctx.save(); ctx.translate(s.x,s.y); ctx.rotate(s.ang);
      const hw = s.w/2, rowH = 13, rowW = s.w, totalH = s.rows*rowH+20;
      ctx.globalAlpha=.3; ctx.fillStyle='#000'; ctx.fillRect(-hw+10,-(totalH)+10,rowW,totalH);
      ctx.globalAlpha=1;
      const wallGr = ctx.createLinearGradient(-hw,-(totalH),hw,4);
      wallGr.addColorStop(0,lightenHex(s.color,8)+'ff');
      wallGr.addColorStop(.6,s.color+'ee');
      wallGr.addColorStop(1,darkenHex(s.color,15)+'cc');
      ctx.fillStyle = wallGr; ctx.fillRect(-hw,-(totalH),rowW,totalH);
      ctx.fillStyle='rgba(160,165,180,.95)'; ctx.fillRect(-hw-8,-(totalH)-16,rowW+16,18);
      ctx.fillStyle='rgba(100,105,120,.8)'; ctx.fillRect(-hw-6,-(totalH)-4,rowW+12,6);
      const cols = Math.floor(rowW/10);
      const seatColors = ['#cc1818','#e8e8e8','#1a3acc','#ddbf00','#1aaa33','#dd5500','#8822cc','#ee8800'];
      for(let r=0; r<s.rows; r++){
        for(let c=0; c<cols; c++){
          const sc = seatColors[(r*5+c+Math.floor(s.w*.6))%seatColors.length];
          ctx.fillStyle = sc+'dd'; ctx.fillRect(-hw+c*10+1,-(totalH)+20+r*rowH+1,9,rowH-2);
          ctx.fillStyle='rgba(255,255,255,.12)'; ctx.fillRect(-hw+c*10+1,-(totalH)+20+r*rowH+1,9,3);
        }
      }
      for(let p2=0; p2<=Math.floor(rowW/40); p2++){ const px = -hw+p2*40; ctx.fillStyle='rgba(60,65,80,.9)'; ctx.fillRect(px,-(totalH),5,totalH); }
      ctx.restore();
    } else if(s.type==='building'){
      ctx.save(); ctx.translate(s.x,s.y); ctx.rotate(s.ang);
      const bw = s.w||65, bh = s.h||90;
      ctx.globalAlpha=.3; ctx.fillStyle='#000'; ctx.fillRect(10,-bh+10,bw,bh);
      ctx.globalAlpha=1;
      const bGr = ctx.createLinearGradient(-bw*.5,-bh,bw*.5,0);
      bGr.addColorStop(0,'rgba(25,35,58,.98)'); bGr.addColorStop(.5,'rgba(18,26,45,.98)'); bGr.addColorStop(1,'rgba(12,18,32,.98)');
      ctx.fillStyle = bGr; ctx.fillRect(-bw*.5,-bh,bw,bh);
      const wCols = Math.floor(bw/15), wRows = Math.floor(bh/18);
      for(let r=0; r<wRows; r++) for(let c=0; c<wCols; c++){
        const lit = Math.sin(s.seed*1.9+r*5.1+c*2.7)>.05;
        const wc = lit ? `rgba(${220+Math.floor(Math.sin(s.seed+r)*20)},${200+Math.floor(Math.cos(s.seed+c)*20)},120,.8)` : 'rgba(20,30,55,.5)';
        ctx.fillStyle = wc; ctx.fillRect(-bw*.5+c*15+4,-bh+r*18+6,10,11);
        if(lit){ ctx.fillStyle='rgba(255,255,200,.2)'; ctx.fillRect(-bw*.5+c*15+4,-bh+r*18+6,10,3); }
      }
      ctx.fillStyle='rgba(30,40,60,.95)'; ctx.fillRect(-bw*.5-3,-bh-4,bw+6,6);
      ctx.restore();
    } else if(s.type==='marshal'){
      ctx.save(); ctx.translate(s.x,s.y); ctx.rotate(s.ang);
      ctx.fillStyle='#2a2a2a'; ctx.fillRect(-4,-18,8,20);
      const mGr = ctx.createLinearGradient(-12,-18,12,0); mGr.addColorStop(0,'#555'); mGr.addColorStop(1,'#333');
      ctx.fillStyle = mGr; ctx.fillRect(-12,-18,24,18);
      ctx.strokeStyle='rgba(0,0,0,.4)'; ctx.lineWidth=1; ctx.strokeRect(-12,-18,24,18);
      const fc = s.side>0 ? '#ffff00' : '#00cc44';
      ctx.fillStyle = fc; ctx.beginPath(); ctx.moveTo(12,-18); ctx.lineTo(26,-18); ctx.lineTo(26,-10); ctx.lineTo(12,-10); ctx.closePath(); ctx.fill();
      ctx.restore();
    }
  });
}

function renderSceneryFront(def){
  const vx0=camX-200, vy0=camY-200, vx1=camX+canvas.width/CAM_ZOOM+200, vy1=camY+canvas.height/CAM_ZOOM+200;
  const vis = s => s.x>=vx0 && s.x<=vx1 && s.y>=vy0 && s.y<=vy1;
  scenery.forEach(s => {
    if(!vis(s)) return;
    if(s.type==='tires'){
      ctx.save(); ctx.translate(s.x,s.y); ctx.rotate(s.ang);
      const count = Math.floor(s.len/14);
      for(let i=0;i<count;i++){
        const tx = (i-count/2)*14;
        ctx.globalAlpha=.2; ctx.fillStyle='#000'; ctx.beginPath(); ctx.ellipse(tx+3,3,7,3,0,0,Math.PI*2); ctx.fill();
        ctx.globalAlpha=1;
        const tGr = ctx.createRadialGradient(tx-2,-2,0,tx,0,7);
        tGr.addColorStop(0,'#444'); tGr.addColorStop(.6,'#222'); tGr.addColorStop(1,'#111');
        ctx.fillStyle = tGr; ctx.beginPath(); ctx.arc(tx,0,6.5,0,Math.PI*2); ctx.fill();
        ctx.fillStyle='#555'; ctx.beginPath(); ctx.arc(tx,0,2.5,0,Math.PI*2); ctx.fill();
        if(i%3===0){ ctx.fillStyle='rgba(255,100,0,.6)'; ctx.beginPath(); ctx.arc(tx,0,6.5,Math.PI*.7,Math.PI*1.3); ctx.arc(tx,0,4,Math.PI*1.3,Math.PI*.7,true); ctx.closePath(); ctx.fill(); }
      }
      ctx.restore();
    } else if(s.type==='adboard'){
      ctx.save(); ctx.translate(s.x,s.y); ctx.rotate(s.ang);
      ctx.fillStyle='#666'; ctx.fillRect(-1.5,-22,3,22);
      ctx.globalAlpha=.25; ctx.fillStyle='#000'; ctx.fillRect(-24,-38,50,22); ctx.globalAlpha=1;
      const bGr = ctx.createLinearGradient(-26,-38,26,-16);
      bGr.addColorStop(0,'rgba(8,8,12,1)'); bGr.addColorStop(1,'rgba(4,4,8,1)');
      ctx.fillStyle = bGr; ctx.fillRect(-26,-38,52,22);
      ctx.strokeStyle = s.color+'aa'; ctx.lineWidth=1.5; ctx.strokeRect(-26,-38,52,22);
      ctx.fillStyle = s.color+'66'; ctx.fillRect(-26,-38,52,3);
      ctx.fillStyle = s.color; ctx.font='bold 7.5px Orbitron,monospace';
      ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.shadowColor = s.color; ctx.shadowBlur=6;
      ctx.fillText(s.text,0,-27);
      ctx.restore();
    } else if(s.type==='grid'){
      ctx.save(); ctx.translate(s.x,s.y); ctx.rotate(s.ang);
      ctx.fillStyle='rgba(255,255,255,.12)'; ctx.fillRect(-18,-11,36,22);
      ctx.strokeStyle='rgba(255,255,255,.4)'; ctx.lineWidth=1.5; ctx.strokeRect(-18,-11,36,22);
      ctx.font='bold 9px Orbitron,monospace'; ctx.fillStyle='rgba(255,255,255,.75)';
      ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(s.num,0,0);
      ctx.restore();
    }
  });
}

function renderCPs(def){
  cpIndices.forEach((si,i)=>{
    const pos = spline[si]; const ang = splineAngle(si/spline.length); const perp = ang+Math.PI/2;
    const hw = trackW*.65; const pulse = .5+.5*Math.sin(raceTime*.005+i*1.4);
    const p1 = {x:pos.x+Math.cos(perp)*hw, y:pos.y+Math.sin(perp)*hw};
    const p2 = {x:pos.x-Math.cos(perp)*hw, y:pos.y-Math.sin(perp)*hw};
    ctx.save(); ctx.globalAlpha = .1+.06*pulse;
    ctx.strokeStyle = def.cpColor; ctx.lineWidth = trackW*1.5;
    ctx.beginPath(); ctx.moveTo(p1.x,p1.y); ctx.lineTo(p2.x,p2.y); ctx.stroke();
    ctx.restore();
    ctx.save(); ctx.globalAlpha = .65+.3*pulse;
    const beamGr = ctx.createLinearGradient(p1.x,p1.y,p2.x,p2.y);
    beamGr.addColorStop(0,def.cpColor+'00'); beamGr.addColorStop(.15,def.cpColor);
    beamGr.addColorStop(.5,lightenHex(def.cpColor,40)); beamGr.addColorStop(.85,def.cpColor);
    beamGr.addColorStop(1,def.cpColor+'00');
    ctx.strokeStyle = beamGr; ctx.lineWidth = 3+pulse*2.5;
    ctx.shadowColor = def.cpColor; ctx.shadowBlur = 12+pulse*8;
    ctx.beginPath(); ctx.moveTo(p1.x,p1.y); ctx.lineTo(p2.x,p2.y); ctx.stroke();
    ctx.restore();
    [p1,p2].forEach(pt=>{
      ctx.save();
      ctx.globalAlpha=.25; ctx.fillStyle='#000';
      ctx.beginPath(); ctx.ellipse(pt.x+3,pt.y+4,8,3,0,0,Math.PI*2); ctx.fill();
      ctx.globalAlpha=1;
      const postGr = ctx.createRadialGradient(pt.x-3,pt.y-3,0,pt.x,pt.y,10);
      postGr.addColorStop(0,lightenHex(def.cpColor,40)); postGr.addColorStop(.5,def.cpColor);
      postGr.addColorStop(1,darkenHex(def.cpColor,30));
      ctx.fillStyle = postGr; ctx.beginPath(); ctx.arc(pt.x,pt.y,7+pulse*1.5,0,Math.PI*2); ctx.fill();
      ctx.globalAlpha=.4+.3*pulse; ctx.strokeStyle = def.cpColor; ctx.lineWidth=2;
      ctx.shadowColor = def.cpColor; ctx.shadowBlur=15+pulse*10;
      ctx.beginPath(); ctx.arc(pt.x,pt.y,10+pulse*3,0,Math.PI*2); ctx.stroke();
      ctx.restore();
    });
    ctx.save();
    const lx = pos.x, ly = pos.y - trackW*.8 - 18;
    ctx.fillStyle = def.cpColor+'18'; ctx.strokeStyle = def.cpColor+'66'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.roundRect(lx-22,ly-11,44,22,4); ctx.fill(); ctx.stroke();
    ctx.font = 'bold 11px Orbitron,monospace'; ctx.fillStyle = def.cpColor;
    ctx.shadowColor = def.cpColor; ctx.shadowBlur = 8;
    ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(`Q${i+1}`,lx,ly);
    ctx.restore();
  });
}

function renderFinish(def){
  const pos = spline[0]; const ang = splineAngle(0); const perp = ang+Math.PI/2; const hw = trackW*.65;
  const pulse = .5+.5*Math.sin(raceTime*.006);
  ctx.save(); ctx.globalAlpha=.08+.05*pulse;
  ctx.strokeStyle='#ffe34d'; ctx.lineWidth=trackW*1.5;
  ctx.shadowColor='#ffdf00'; ctx.shadowBlur=40;
  ctx.beginPath(); ctx.moveTo(pos.x+Math.cos(perp)*hw, pos.y+Math.sin(perp)*hw);
  ctx.lineTo(pos.x-Math.cos(perp)*hw, pos.y-Math.sin(perp)*hw); ctx.stroke();
  ctx.restore();
  ctx.save();
  const g1 = {x:pos.x+Math.cos(perp)*(hw+12), y:pos.y+Math.sin(perp)*(hw+12)};
  const g2 = {x:pos.x-Math.cos(perp)*(hw+12), y:pos.y-Math.sin(perp)*(hw+12)};
  ctx.strokeStyle='#888'; ctx.lineWidth=8; ctx.lineCap='butt';
  ctx.beginPath(); ctx.moveTo(g1.x,g1.y); ctx.lineTo(g2.x,g2.y); ctx.stroke();
  ctx.strokeStyle='rgba(255,255,255,.35)'; ctx.lineWidth=2;
  ctx.beginPath(); ctx.moveTo(g1.x,g1.y); ctx.lineTo(g2.x,g2.y); ctx.stroke();
  [g1,g2].forEach(pt=>{
    ctx.strokeStyle='#666'; ctx.lineWidth=10; ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(pt.x,pt.y); ctx.lineTo(pt.x+Math.cos(ang)*8, pt.y+Math.sin(ang)*8); ctx.stroke();
  });
  ctx.restore();
  const sq = 10, steps = Math.floor(hw*2/sq);
  for(let r=0; r<3; r++) for(let c=0; c<steps; c++){
    const frac = (c+.5)/steps;
    const px = pos.x + Math.cos(perp)*(hw - frac*hw*2);
    const py = pos.y + Math.sin(perp)*(hw - frac*hw*2);
    ctx.fillStyle = (c+r)%2===0 ? 'rgba(255,255,255,.95)' : 'rgba(0,0,0,.9)';
    ctx.save(); ctx.translate(px,py); ctx.rotate(ang); ctx.fillRect(-sq/2, -sq*(r+.5), sq, sq); ctx.restore();
  }
  ctx.save();
  ctx.font = 'bold 14px Orbitron,monospace'; ctx.fillStyle = 'rgba(255,220,50,.95)';
  ctx.shadowColor = '#ffdf00'; ctx.shadowBlur = 20;
  ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillText('FINISH', pos.x, pos.y-hw-22);
  ctx.restore();
}

function renderPlayer(p,def){
  const size = isMobile ? 17 : 22;
  if(p.trail.length>1){
    ctx.save();
    for(let i=1; i<p.trail.length; i++){
      const t = p.trail[i]; const prev = p.trail[i-1];
      const progress = i/p.trail.length;
      ctx.globalAlpha = t.a * (p.boost?0.7:0.35);
      if(p.boost){
        const trGr = ctx.createLinearGradient(prev.x,prev.y,t.x,t.y);
        trGr.addColorStop(0,`rgba(255,140,0,${t.a*.8})`);
        trGr.addColorStop(.5,`rgba(255,60,0,${t.a*.5})`);
        trGr.addColorStop(1,`rgba(255,200,0,${t.a*.3})`);
        ctx.strokeStyle = trGr; ctx.lineWidth = 5*progress+1;
      }else{
        ctx.strokeStyle = p.color; ctx.lineWidth = 3*progress+1;
      }
      ctx.lineCap='round'; ctx.beginPath(); ctx.moveTo(prev.x,prev.y); ctx.lineTo(t.x,t.y); ctx.stroke();
    }
    ctx.globalAlpha=1; ctx.restore();
  }
  ctx.save(); ctx.globalAlpha=.3;
  ctx.fillStyle='rgba(0,0,0,.7)';
  const shadowScaleX=1.4, shadowScaleY=.35;
  ctx.translate(p.x+4, p.y+6); ctx.rotate(p.ang+Math.PI/2);
  ctx.scale(shadowScaleX, shadowScaleY);
  ctx.beginPath(); ctx.ellipse(0,0,size*.9,size*.6,0,0,Math.PI*2); ctx.fill();
  ctx.restore();
  ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.ang+Math.PI/2);
  const carDef = {...p.car, _flame:p.flame};
  drawF1CarShape(ctx, carDef, size);
  ctx.restore();
  if(p.boost && !p._sparks) p._sparks=[];
  if(p.boost && p._sparks){
    if(Math.random()<.5){
      const a = p.ang+Math.PI+(-0.3+Math.random()*.6);
      p._sparks.push({x:p.x,y:p.y, vx:Math.cos(a)*(.5+Math.random()*2), vy:Math.sin(a)*(.5+Math.random()*2), life:1, r:1+Math.random()*2});
    }
    p._sparks = p._sparks.filter(s=>s.life>0);
    ctx.save();
    p._sparks.forEach(s=>{
      s.x += s.vx; s.y += s.vy; s.life -= .08; s.vx *= .92; s.vy *= .92;
      ctx.globalAlpha = s.life;
      const sc = s.life>.5 ? '#ffcc00' : (s.life>.25 ? '#ff6600' : '#ff2200');
      ctx.fillStyle = sc; ctx.beginPath(); ctx.arc(s.x,s.y, Math.max(0,s.r*s.life),0,Math.PI*2); ctx.fill();
    });
    ctx.restore();
  }
  if(p.id === myId){
    ctx.save(); ctx.globalAlpha = .22+.08*Math.sin(raceTime*.008);
    ctx.strokeStyle = p.color; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.arc(p.x,p.y, size+8, 0, Math.PI*2); ctx.stroke();
    ctx.restore();
  }
  if(p.id !== myId){
    ctx.save(); ctx.globalAlpha = .9;
    const tw = ctx.measureText((p.name+' '+p.car.model).slice(0,14)).width + 16;
    ctx.fillStyle = 'rgba(0,5,20,.88)'; ctx.strokeStyle = p.color+'55'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.roundRect(p.x - tw/2, p.y-size-38, tw, 18, 3); ctx.fill(); ctx.stroke();
    ctx.font = '600 7px Orbitron,monospace'; ctx.fillStyle = p.color; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText((p.name+' '+p.car.model).slice(0,14), p.x, p.y-size-30); ctx.restore();
  }
  if(p.fin){
    ctx.save();
    ctx.font = 'bold 10px Orbitron,monospace';
    ctx.fillStyle = 'rgba(255,215,0,.9)';
    ctx.shadowColor = '#ffdf00';
    ctx.shadowBlur = 10;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('‚úì', p.x, p.y - size - 25);
    ctx.restore();
  }
}

function renderMinimap(){
  if(!room || !spline.length) return;
  const def = TRACK_DEFS[room.track||0];
  const mw = 170, mh = 118;
  const mx = canvas.width - mw - 14;
  const my = canvas.height - mh - 18;
  const scx = mw/WORLD_W, scy = mh/WORLD_H;
  const pad = 6;
  ctx.save();
  ctx.fillStyle = 'rgba(0,4,16,.92)';
  ctx.strokeStyle = def.accentColor+'55'; ctx.lineWidth=1.5;
  ctx.beginPath(); ctx.roundRect(mx,my,mw,mh,5); ctx.fill(); ctx.stroke();
  ctx.strokeStyle = def.accentColor+'22'; ctx.lineWidth=6;
  ctx.beginPath(); ctx.roundRect(mx+2,my+2,mw-4,mh-4,4); ctx.stroke();
  ctx.beginPath(); ctx.roundRect(mx+pad,my+pad,mw-pad*2,mh-pad*2,3); ctx.clip();
  ctx.translate(mx+pad, my+pad);
  const smx = (mw-pad*2)/WORLD_W, smy = (mh-pad*2)/WORLD_H;
  ctx.strokeStyle = def.road+'44'; ctx.lineWidth=6;
  ctx.beginPath(); spline.forEach((p,i)=>{const px=p.x*smx, py=p.y*smy; if(i===0)ctx.moveTo(px,py); else ctx.lineTo(px,py);}); ctx.closePath(); ctx.stroke();
  ctx.strokeStyle = def.road+'cc'; ctx.lineWidth=3.5;
  ctx.beginPath(); spline.forEach((p,i)=>{const px=p.x*smx, py=p.y*smy; if(i===0)ctx.moveTo(px,py); else ctx.lineTo(px,py);}); ctx.closePath(); ctx.stroke();
  cpIndices.forEach((si,i)=>{
    const p = spline[si];
    ctx.fillStyle = def.cpColor; ctx.shadowColor = def.cpColor; ctx.shadowBlur = 4;
    ctx.beginPath(); ctx.arc(p.x*smx, p.y*smy, 2.5, 0, Math.PI*2); ctx.fill();
  });
  const fp = spline[0];
  ctx.strokeStyle = 'rgba(255,220,0,.9)'; ctx.lineWidth=2;
  ctx.beginPath(); ctx.arc(fp.x*smx, fp.y*smy, 5, 0, Math.PI*2); ctx.stroke();
  players.forEach(p => {
    const px = p.x*smx, py = p.y*smy;
    const isMe = p.id === myId;
    ctx.shadowColor = p.color; ctx.shadowBlur = isMe ? 8 : 4;
    ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(px,py, isMe?4.5:3,0,Math.PI*2); ctx.fill();
    ctx.save(); ctx.translate(px,py); ctx.rotate(p.ang);
    ctx.fillStyle = p.color; ctx.globalAlpha = .8;
    ctx.beginPath(); ctx.moveTo(0, -(isMe?7:5)); ctx.lineTo(isMe?3:2,0); ctx.lineTo(-(isMe?3:2),0); ctx.closePath(); ctx.fill();
    ctx.restore();
    if(isMe){ ctx.strokeStyle = p.color; ctx.lineWidth=1.5; ctx.globalAlpha=.5; ctx.beginPath(); ctx.arc(px,py,7,0,Math.PI*2); ctx.stroke(); }
    ctx.globalAlpha=1; ctx.shadowBlur=0;
  });
  ctx.restore();
  ctx.font = '600 6px Orbitron,monospace'; ctx.fillStyle = def.accentColor+'88';
  ctx.textAlign='center'; ctx.textBaseline='top';
  ctx.fillText(def.name||'CIRCUIT', mx+mw/2, my+3);
  ctx.restore();
}

function updateHUD(){
  if(!myP) return;
  if(myP.boost){ document.getElementById('boost-hud').style.display='flex'; document.getElementById('boost-fill').style.width = (myP.boostMs/myP.boostDur*100)+'%'; }
  else document.getElementById('boost-hud').style.display='none';
  document.getElementById('hud-me').innerHTML = `<div class="hud-name" style="color:${myP.color}">${myP.emoji} ${myP.name}</div><div class="hud-stat" style="color:${myP.car.primaryColor};font-size:.58rem;">${myP.car.team} ${myP.car.model}</div><div class="hud-stat">CP <b>${myP.checkpt}/5</b></div><div class="hud-stat">‚úì <b>${myP.score}</b> &nbsp; ‚ö° <b>${myP.boosts}</b></div>`;
  
  // Show how many players have finished
  const finishedCount = players.filter(p => p.fin).length;
  const totalPlayers = players.length;
  if(finishedCount > 0 && finishedCount < totalPlayers) {
    document.getElementById('hud-cp').textContent = `FINISHED: ${finishedCount}/${totalPlayers}`;
  } else {
    document.getElementById('hud-cp').textContent = `CHECKPOINT ${Math.min(myP.checkpt,5)}/5`;
  }
  
  const s = Math.floor(raceTime/1000), ms = Math.floor((raceTime%1000)/10);
  document.getElementById('hud-time').textContent = `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}.${String(ms).padStart(2,'0')}`;
  
  // Update other players display with finish status and scores
  document.getElementById('hud-others').innerHTML = players
    .filter(p => p.id !== myId)
    .map(p => {
      const status = p.fin ? 'üèÅ' : `CP ${p.checkpt}/5`;
      return `<div class="hud-card" style="border-color:${p.color}44;min-width:110px;">
        <div class="hud-name" style="color:${p.color}">${p.emoji} ${p.name.slice(0,8)}</div>
        <div class="hud-stat">${status}</div>
        <div class="hud-stat" style="font-size:.5rem;">‚úì${p.score} ‚ö°${p.boosts}</div>
      </div>`;
    }).join('');
}

function showResults(){
  canvas.style.display='none'; document.getElementById('hud').style.display='none';
  document.getElementById('boost-hud').style.display='none'; document.getElementById('qOverlay').style.display='none';
  if(pingEl) pingEl.style.opacity='0';
  
  // Get all players with their final stats
  const allPlayers = [...players];
  
  // If multiplayer, also fetch latest from Firebase for other players
  if(room && room.code !== 'SOLO' && roomRef) {
    db.ref('rooms/' + room.code + '/players').once('value').then(snap => {
      if(snap.exists()) {
        const fbPlayers = snap.val();
        // Update local players with Firebase data
        allPlayers.forEach(p => {
          if(fbPlayers[p.id]) {
            p.fin = fbPlayers[p.id].fin || p.fin;
            p.finTime = fbPlayers[p.id].ftime || p.finTime;
            p.score = fbPlayers[p.id].score || p.score;
            p.boosts = fbPlayers[p.id].boosts || p.boosts;
          }
        });
      }
      displayResults(allPlayers);
    }).catch(() => {
      // If Firebase fetch fails, just use local data
      displayResults(allPlayers);
    });
  } else {
    // Solo mode - just display local results
    displayResults(allPlayers);
  }
}

function displayResults(playersList){
  // Sort players: finished first (by finish time), then by checkpoints
  const sorted = [...playersList].sort((a,b) => {
    if(a.fin && b.fin) return a.finTime - b.finTime;
    if(a.fin) return -1;
    if(b.fin) return 1;
    return b.checkpt - a.checkpt;
  });
  
  const tro = ['ü•á','ü•à','ü•â','üèÖ'];
  document.getElementById('lb-body').innerHTML = sorted.map((p,i) => {
    const t = p.finTime || raceTime;
    const sec = Math.floor(t/1000);
    const ms = Math.floor((t%1000)/10);
    const ts = `${String(Math.floor(sec/60)).padStart(2,'0')}:${String(sec%60).padStart(2,'0')}.${String(ms).padStart(2,'0')}`;
    
    // Show finish status
    const finishBadge = p.fin ? '‚úì FINISHED' : '‚è≥ RACING';
    
    return `<tr>
      <td class="rank">${tro[i]||''}</td>
      <td class="pname" style="color:${p.color}">
        ${p.emoji} ${p.name}<br>
        <span style="font-size:.5rem;color:var(--dim);">${p.car ? p.car.model : ''}</span>
      </td>
      <td class="mono">${p.score}</td>
      <td class="mono">${p.boosts}</td>
      <td class="mono">${ts}</td>
      <td class="mono" style="color:${p.fin ? 'var(--green)' : 'var(--yellow)'}">${finishBadge}</td>
    </tr>`;
  }).join('');
  
  // Add a header for the new column
  const table = document.querySelector('.lb');
  if(table) {
    const thead = table.querySelector('thead tr');
    if(thead && thead.children.length < 6) {
      thead.innerHTML = '<th style="text-align:center;">#</th><th>PILOT</th><th style="text-align:center;">‚úì</th><th style="text-align:center;">‚ö°</th><th style="text-align:center;">TIME</th><th style="text-align:center;">STATUS</th>';
    }
  }
  
  _cur='resultsScreen'; 
  document.getElementById('resultsScreen').classList.remove('gone');
  
  // Show waiting message if not all finished
  const notFinished = playersList.filter(p => !p.fin).length;
  if(notFinished > 0) {
    const resultTitle = document.querySelector('.result-title');
    if(resultTitle) {
      resultTitle.innerHTML = `üèÅ RACE COMPLETE <span style="font-size:.6rem;color:var(--dim);">(waiting for ${notFinished})</span>`;
    }
  }
}

function playAgain(){
  document.getElementById('resultsScreen').classList.add('gone');
  stopPosPush(); stopPing();
  if(room && room.code !== 'SOLO'){
    if(amHost){
      const rp = {};
      Object.values(room.players || {}).forEach(p => {
        rp[p.id] = {...p, score:0, boosts:0, ftime:0, checkpt:0, fin:false};
      });
      roomRef.update({state:'lobby', players:rp});
      openLobby();
    } else {
      _cur='s-lobby'; renderLobby(); document.getElementById('s-lobby').classList.remove('gone');
    }
  } else {
    soloRace();
  }
}

function cleanupGame(){
  gameOn=false; ended=true;
  if(raf){ cancelAnimationFrame(raf); raf=null; }
  canvas.style.display='none'; document.getElementById('hud').style.display='none';
  document.getElementById('qOverlay').style.display='none'; document.getElementById('touch-controls').style.display='none';
  document.getElementById('gear-hud').style.display='none';
  if(pingEl) pingEl.style.opacity='0';
  bgCache=null; document.onkeydown=null; document.onkeyup=null;
  players=[]; myP=null;
}

window.addEventListener('resize', ()=>{
  if(!gameOn && !raf) return;
  canvas.width = innerWidth; canvas.height = innerHeight; bgCache=null;
  if(room){ const def = TRACK_DEFS[room.track||0]; spline = buildSpline(def.ctrl,WORLD_W,WORLD_H,3000); buildCheckpoints(); buildScenery(def); buildRoadMarkers(); }
});
</script>
</body>
</html>